<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ガンダム & ポケふた マンホールマップ | 聖地巡礼支援</title>
  <meta name="description" content="ガンダムマンホールとポケふたを1枚の地図で統合表示。キャラクター・ポケモン・重複地点を可視化し聖地巡礼計画に活用。">
  <meta name="keywords" content="ガンダムマンホール,ポケふた,マンホール,ガンダム,ポケモン,聖地巡礼,地図">
  <meta name="robots" content="index,follow">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ja_JP">
  <meta property="og:title" content="ガンダム & ポケふた マンホールマップ | 聖地巡礼支援">
  <meta property="og:description" content="ガンダムマンホールとポケふたを統合。キャラクターやポケモンでフィルタ可能。">
  <meta property="og:url" content="https://nishiokya.github.io/pokefuta-tracker/gmanhole_map.html">
  <meta property="og:image" content="https://nishiokya.github.io/pokefuta-tracker/assets/manhole_icon.png">
  <link rel="canonical" href="https://nishiokya.github.io/pokefuta-tracker/gmanhole_map.html">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="./assets/theme.css" />
  <link rel="stylesheet" href="./assets/map.css" />
  <style>
    /* Franchise specific marker styling (DivIcon) */
    .fr-marker { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:15px; font-weight:600; color:#fff; box-shadow:0 0 0 2px #fff, 0 2px 6px rgba(0,0,0,.35); }
    .fr-pokemon { background:linear-gradient(135deg,#ffcc00,#ff6b00); }
    .fr-gundam { background:linear-gradient(135deg,#0044aa,#cc0000); }
    .fr-both { background:linear-gradient(135deg,#6a00cc,#ff0066); }
    #controls { max-width:340px; }
    .legend { margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:4px; font-size:0.75rem; }
    .legend-swatch { width:18px; height:18px; border-radius:50%; box-shadow:0 0 0 1px #fff,0 1px 3px rgba(0,0,0,.3); }
    .legend-pokemon { background:linear-gradient(135deg,#ffcc00,#ff6b00); }
    .legend-gundam { background:linear-gradient(135deg,#0044aa,#cc0000); }
    .legend-both { background:linear-gradient(135deg,#6a00cc,#ff0066); }
    .character-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(90px,1fr)); gap:4px; margin-top:4px; max-height:220px; overflow:auto; }
    .character-item { background:#f5f7fa; border:1px solid #dde; padding:4px 6px; border-radius:6px; cursor:pointer; font-size:0.7rem; display:flex; flex-direction:column; gap:2px; }
    .character-item.selected { background:#334; color:#fff; }
    .character-count { font-size:0.65rem; opacity:0.7; }
    .franchise-filter-group { display:flex; gap:8px; flex-wrap:wrap; margin:4px 0 8px; }
    .franchise-filter-group label { font-size:0.8rem; cursor:pointer; display:flex; align-items:center; gap:4px; }
    .dataset-summary { font-size:0.65rem; color:#555; margin-top:4px; }
    .popup-box { font-size:0.8rem; line-height:1.2; }
    .popup-box .popup-title { font-weight:600; }
    .stat-inline { font-size:0.7rem; color:#444; margin:2px 0; }
    .filter-section { margin-bottom:10px; }
  </style>
  <link rel="icon" href="./assets/manhole_icon.png" type="image/png" />
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K18NR4GZG2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
    gtag('config', 'G-K18NR4GZG2', { 'anonymize_ip': true });
  </script>
  <!-- End GA -->
</head>
<body>
  <div id="controls" role="complementary" aria-labelledby="page-title">
    <div class="controls-header">
      <h3 id="page-title">🕳 ガンダム & ポケふた マップ</h3>
  <a href="./" class="nav-link" style="margin-right: 8px;">← ポケふたマップ</a>
  <a href="./nearby_manholes.html" class="nav-link" id="nav-link">📍 近くのマンホール</a>
    </div>
    <div class="controls-content" role="region" aria-label="Filters and statistics">
      <div class="filter-section">
        <h4 style="margin:4px 0;">表示設定</h4>
        <div class="franchise-filter-group" role="group" aria-label="Franchise filters">
          <label><input type="checkbox" id="chk-pokemon" checked aria-label="ポケモン表示" /> ポケモン</label>
          <label><input type="checkbox" id="chk-gundam" checked aria-label="ガンダム表示" /> ガンダム</label>
        </div>
        <div class="legend" aria-label="Legend">
          <div class="legend-item"><span class="legend-swatch legend-pokemon"></span>ポケふた</div>
          <div class="legend-item"><span class="legend-swatch legend-gundam"></span>ガンダム</div>
          <div class="legend-item"><span class="legend-swatch legend-both"></span>座標共有/重複</div>
        </div>
      </div>
      <div class="filter-section">
        <h4 style="margin:4px 0;">都道府県別件数</h4>
        <div id="prefecture-counts" style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></div>
      </div>
      <div class="stats" role="status" aria-live="polite">
        <div id="total-count">総数: <span>0</span></div>
        <div id="visible-count">表示: <span>0</span></div>
        <div id="gundam-count">ガンダム: <span>0</span></div>
        <div id="pokemon-count">ポケふた: <span>0</span></div>
      </div>
    </div>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([36.0, 138.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    function franchiseIcon(franchise, overlap=false) {
      let cls = 'fr-marker ';
      if (overlap) cls += 'fr-both';
      else if (franchise === 'gundam') cls += 'fr-gundam';
      else if (franchise === 'pokefuta' || franchise === 'pokemon') cls += 'fr-pokemon';
      else cls += 'fr-pokemon';
      const label = overlap ? '◎' : (franchise === 'gundam' ? 'G' : 'P');
      return L.divIcon({ className: cls, html: label, iconSize: [30,30], iconAnchor:[15,15], popupAnchor:[0,-15] });
    }

    // Data containers
    let gundamData = []; // gmanhole
    let pokemonData = []; // pokefuta
    let allMarkers = [];

    // 都道府県コードマッピング
    const prefectureCodeMap = {
      '北海道': '01', '青森県': '02', '岩手県': '03', '宮城県': '04', '秋田県': '05',
      '山形県': '06', '福島県': '07', '茨城県': '08', '栃木県': '09', '群馬県': '10',
      '埼玉県': '11', '千葉県': '12', '東京都': '13', '神奈川県': '14', '新潟県': '15',
      '富山県': '16', '石川県': '17', '福井県': '18', '山梨県': '19', '長野県': '20',
      '岐阜県': '21', '静岡県': '22', '愛知県': '23', '三重県': '24', '滋賀県': '25',
      '京都府': '26', '大阪府': '27', '兵庫県': '28', '奈良県': '29', '和歌山県': '30',
      '鳥取県': '31', '島根県': '32', '岡山県': '33', '広島県': '34', '山口県': '35',
      '徳島県': '36', '香川県': '37', '愛媛県': '38', '高知県': '39', '福岡県': '40',
      '佐賀県': '41', '長崎県': '42', '熊本県': '43', '大分県': '44', '宮崎県': '45',
      '鹿児島県': '46', '沖縄県': '47'
    };

    // 都道府県の中心座標マッピング（緯度, 経度）
    const prefectureCenterCoords = {
      '北海道': [43.064, 141.347], '青森県': [40.824, 140.740], '岩手県': [39.703, 141.153],
      '宮城県': [38.269, 140.872], '秋田県': [39.719, 140.103], '山形県': [38.240, 140.363],
      '福島県': [37.750, 140.468], '茨城県': [36.342, 140.447], '栃木県': [36.566, 139.883],
      '群馬県': [36.391, 139.061], '埼玉県': [35.857, 139.649], '千葉県': [35.605, 140.123],
      '東京都': [35.690, 139.692], '神奈川県': [35.448, 139.643], '新潟県': [37.902, 139.023],
      '富山県': [36.695, 137.211], '石川県': [36.595, 136.626], '福井県': [35.943, 136.189],
      '山梨県': [35.664, 138.568], '長野県': [36.651, 138.181], '岐阜県': [35.391, 136.722],
      '静岡県': [34.977, 138.383], '愛知県': [35.180, 136.907], '三重県': [34.730, 136.509],
      '滋賀県': [35.004, 135.869], '京都府': [35.021, 135.756], '大阪府': [34.686, 135.520],
      '兵庫県': [34.691, 135.183], '奈良県': [34.685, 135.833], '和歌山県': [34.226, 135.167],
      '鳥取県': [35.504, 134.238], '島根県': [35.472, 133.051], '岡山県': [34.662, 133.935],
      '広島県': [34.396, 132.460], '山口県': [34.186, 131.471], '徳島県': [34.066, 134.559],
      '香川県': [34.340, 134.043], '愛媛県': [33.842, 132.766], '高知県': [33.560, 133.531],
      '福岡県': [33.607, 130.418], '佐賀県': [33.250, 130.299], '長崎県': [32.745, 129.874],
      '熊本県': [32.790, 130.742], '大分県': [33.238, 131.613], '宮崎県': [31.911, 131.424],
      '鹿児島県': [31.560, 130.558], '沖縄県': [26.212, 127.679]
    };

    async function loadDatasets(){
      try {
        // Try multiple potential paths for pokefuta data
        const pokefutaPaths = [
          './pokefuta.ndjson',  // Current relative path
          'pokefuta.ndjson',    // Direct filename
          '../pokefuta.ndjson', // Parent directory
          'https://raw.githubusercontent.com/nishiokya/pokefuta-tracker/main/docs/pokefuta.ndjson' // Fallback to GitHub raw
        ];
        
        let pRes = null;
        for (const path of pokefutaPaths) {
          try {
            console.log(`Trying to fetch pokefuta data from: ${path}`);
            pRes = await fetch(path);
            if (pRes.ok) {
              console.log(`Successfully loaded pokefuta data from: ${path}`);
              break;
            }
          } catch (e) {
            console.warn(`Failed to fetch from ${path}:`, e);
          }
        }
        
        if (!pRes || !pRes.ok) {
          throw new Error('Could not load pokefuta data from any path');
        }
        
        const [gRes] = await Promise.all([
          fetch('./assets/gmanhole.ndjson')
        ]);
        
        gundamData = await parseNdjson(gRes);
        pokemonData = await parseNdjson(pRes);
        buildMarkers();
        buildPrefectureCounts();
        updateStats();
      } catch(e){ console.error('Failed to load datasets', e); }
    }

    async function parseNdjson(response){
      const text = await response.text();
      return text.trim().split('\n').filter(Boolean).map(line => {
        try { return JSON.parse(line); } catch { return null; }
      }).filter(Boolean);
    }

    function buildMarkers() {
      allMarkers.forEach(m => { if (map.hasLayer(m)) map.removeLayer(m); });
      allMarkers = [];
      // Determine overlaps -> same lat/lng (rounded) between franchises
      const locKey = d => d.lat != null && d.lng != null ? (d.lat.toFixed(5)+'|'+d.lng.toFixed(5)) : null;
      const pokemonLocs = new Set(pokemonData.map(locKey).filter(Boolean));
      const gundamLocs = new Set(gundamData.map(locKey).filter(Boolean));
      const overlapLocs = new Set([...pokemonLocs].filter(k => gundamLocs.has(k)));

      gundamData.forEach(d => {
        if (d.lat == null || d.lng == null) return; // skip unless geocoded
        const overlap = overlapLocs.has(locKey(d));
        const popup = buildGundamPopup(d, overlap);
        const marker = L.marker([d.lat, d.lng], { icon: franchiseIcon('gundam', overlap) }).bindPopup(popup);
        marker._data = { ...d, franchise:'gundam', overlap };
        marker.addTo(map); allMarkers.push(marker);
      });
      pokemonData.forEach(d => {
        if (d.lat == null || d.lng == null) return;
        const overlap = overlapLocs.has(locKey(d));
        const popup = buildPokemonPopup(d, overlap);
        const marker = L.marker([d.lat, d.lng], { icon: franchiseIcon('pokefuta', overlap) }).bindPopup(popup);
        marker._data = { ...d, franchise:'pokefuta', overlap };
        marker.addTo(map); allMarkers.push(marker);
      });
      recomputeVisibility();
    }

    function buildPrefectureCounts() {
      const container = document.getElementById('prefecture-counts');
      if (!container) return;

      const counts = {};
      
      // Count Gundam manholes by prefecture
      gundamData.forEach(d => {
        const pref = d.prefecture || '不明';
        if (!counts[pref]) counts[pref] = { gundam: 0, pokemon: 0 };
        counts[pref].gundam++;
      });

      // Count Pokemon manholes by prefecture
      pokemonData.forEach(d => {
        const pref = d.prefecture || '不明';
        if (!counts[pref]) counts[pref] = { gundam: 0, pokemon: 0 };
        counts[pref].pokemon++;
      });

      // Sort prefectures by prefecture code order
      const sortedPrefectures = Object.entries(counts)
        .sort(([a], [b]) => {
          const codeA = prefectureCodeMap[a] || '99'; // '不明' gets '99'
          const codeB = prefectureCodeMap[b] || '99';
          return codeA.localeCompare(codeB);
        });

      container.innerHTML = sortedPrefectures.map(([pref, count]) => {
        const total = count.gundam + count.pokemon;
        const prefCode = prefectureCodeMap[pref] || '--';
        const gundamText = count.gundam > 0 ? `ガンダム: ${count.gundam}` : '';
        const pokemonText = count.pokemon > 0 ? `ポケモン: ${count.pokemon}` : '';
        const details = [gundamText, pokemonText].filter(Boolean).join(', ');
        
        return `<div class="prefecture-item" data-prefecture="${pref}" style="padding: 4px 6px; border-bottom: 1px solid #eee; cursor: pointer; border-radius: 4px; transition: all 0.2s ease;" 
                onmouseover="this.style.backgroundColor='#f0f8ff'; this.style.transform='translateX(2px)'" 
                onmouseout="this.style.backgroundColor=''; this.style.transform='translateX(0)'" 
                onclick="zoomToPrefecture('${pref}')">
          <div style="font-weight: 600; color: #333;">${prefCode} ${pref} (${total}件)</div>
          <div style="font-size: 0.75rem; color: #666; margin-left: 8px;">${details}</div>
        </div>`;
      }).join('');
    }

    // Leafletの機能を使って都道府県のマンホールにズームする関数
    function zoomToPrefecture(prefecture) {
      console.log(`Zooming to prefecture: ${prefecture}`);
      
      // 指定された都道府県のマンホールマーカーを取得
      const prefectureMarkers = allMarkers.filter(marker => {
        const showPokemon = document.getElementById('chk-pokemon')?.checked;
        const showGundam = document.getElementById('chk-gundam')?.checked;
        const data = marker._data;
        
        // 表示設定に応じてフィルタ
        let shouldShow = false;
        if (data.franchise === 'gundam' && showGundam) shouldShow = true;
        if (data.franchise === 'pokefuta' && showPokemon) shouldShow = true;
        
        return shouldShow && data.prefecture === prefecture;
      });

      if (prefectureMarkers.length === 0) {
        console.warn(`No visible manholes found for prefecture: ${prefecture}`);
        // マンホールがない場合は都道府県の中心座標にズーム
        const center = prefectureCenterCoords[prefecture];
        if (center) {
          map.setView(center, 8);
        }
        return;
      }

      // LeafletのFeatureGroupを使って境界を計算
      const group = L.featureGroup(prefectureMarkers);
      
      try {
        if (prefectureMarkers.length === 1) {
          // 1つのマンホールの場合：そのマンホールを中心にズーム
          const marker = prefectureMarkers[0];
          map.setView([marker._data.lat, marker._data.lng], 12);
        } else {
          // 複数のマンホールの場合：全てが見えるようにfitBounds
          map.fitBounds(group.getBounds(), {
            padding: [20, 20],
            maxZoom: 14
          });
        }
        
        // 都道府県項目を一時的にハイライト
        highlightPrefectureItem(prefecture);
        
        console.log(`Successfully zoomed to ${prefecture} with ${prefectureMarkers.length} visible manholes`);
        
      } catch (error) {
        console.error(`Error zooming to ${prefecture}:`, error);
        // エラーの場合は都道府県の中心座標にフォールバック
        const center = prefectureCenterCoords[prefecture];
        if (center) {
          map.setView(center, 8);
        }
      }
    }

    // 都道府県項目をハイライトする関数
    function highlightPrefectureItem(prefecture) {
      const items = document.querySelectorAll('.prefecture-item');
      items.forEach(item => {
        if (item.dataset.prefecture === prefecture) {
          const originalBg = item.style.backgroundColor;
          const originalBorder = item.style.border;
          
          // ハイライト効果
          item.style.backgroundColor = '#e3f2fd';
          item.style.border = '2px solid #2196f3';
          item.style.boxShadow = '0 2px 8px rgba(33, 150, 243, 0.3)';
          
          // 2秒後に元に戻す
          setTimeout(() => {
            item.style.backgroundColor = originalBg;
            item.style.border = originalBorder;
            item.style.boxShadow = '';
          }, 2000);
        }
      });
    }

    function buildMarkers() {
      allMarkers.forEach(m => { if (map.hasLayer(m)) map.removeLayer(m); });
      allMarkers = [];
      // Determine overlaps -> same lat/lng (rounded) between franchises
      const locKey = d => d.lat != null && d.lng != null ? (d.lat.toFixed(5)+'|'+d.lng.toFixed(5)) : null;
      const pokemonLocs = new Set(pokemonData.map(locKey).filter(Boolean));
      const gundamLocs = new Set(gundamData.map(locKey).filter(Boolean));
      const overlapLocs = new Set([...pokemonLocs].filter(k => gundamLocs.has(k)));

      gundamData.forEach(d => {
        if (d.lat == null || d.lng == null) return; // skip unless geocoded
        const overlap = overlapLocs.has(locKey(d));
        const popup = buildGundamPopup(d, overlap);
        const marker = L.marker([d.lat, d.lng], { icon: franchiseIcon('gundam', overlap) }).bindPopup(popup);
        marker._data = { ...d, franchise:'gundam', overlap };
        marker.addTo(map); allMarkers.push(marker);
      });
      pokemonData.forEach(d => {
        if (d.lat == null || d.lng == null) return;
        const overlap = overlapLocs.has(locKey(d));
        const popup = buildPokemonPopup(d, overlap);
        const marker = L.marker([d.lat, d.lng], { icon: franchiseIcon('pokefuta', overlap) }).bindPopup(popup);
        marker._data = { ...d, franchise:'pokefuta', overlap };
        marker.addTo(map); allMarkers.push(marker);
      });
      recomputeVisibility();
    }

    function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function buildGundamPopup(d, overlap){
      const chars = Array.isArray(d.characters)&&d.characters.length ? d.characters.join(', ') : '—';
      const series = d.series || '—';
      const imgs = Array.isArray(d.image_urls)&&d.image_urls.length ? `<div style='margin-top:4px;'>画像:${d.images_count}</div>`:'<div style="margin-top:4px;">画像なし</div>';
      return `<div class='popup-box'>
        <b>ID:</b> ${esc(d.id)}<br/><b>タイトル:</b> <span class='popup-title'>${esc(d.title)}</span><br/>
        <b>都道府県:</b> ${esc(d.prefecture||'')} / ${esc(d.city||'')}<br/>
        <b>キャラクター:</b> ${esc(chars)}<br/><b>シリーズ:</b> ${esc(series)}${imgs}
        <br/><a href='${esc(d.detail_url)}' target='_blank' rel='noopener'>📝 詳細</a>${overlap?'<br/><span class="stat-inline">※ 座標重複</span>':''}
      </div>`;
    }

    function buildPokemonPopup(d, overlap){
      const pokes = Array.isArray(d.pokemons)&&d.pokemons.length ? d.pokemons.join(', ') : '—';
      return `<div class='popup-box'>
        <b>ID:</b> ${esc(d.id)}<br/><b>タイトル:</b> <span class='popup-title'>${esc(d.title)}</span><br/>
        <b>都道府県:</b> ${esc(d.prefecture||'')} / ${esc(d.city||'')}<br/>
        <b>ポケモン:</b> ${esc(pokes)}
        <br/><a href='${esc(d.detail_url)}' target='_blank' rel='noopener'>📝 詳細</a>${overlap?'<br/><span class="stat-inline">※ 座標重複</span>':''}
      </div>`;
    }

    function buildPokemonPopup(d, overlap){
      const pokes = Array.isArray(d.pokemons)&&d.pokemons.length ? d.pokemons.join(', ') : '—';
      return `<div class='popup-box'>
        <b>ID:</b> ${esc(d.id)}<br/><b>タイトル:</b> <span class='popup-title'>${esc(d.title)}</span><br/>
        <b>都道府県:</b> ${esc(d.prefecture||'')} / ${esc(d.city||'')}<br/>
        <b>ポケモン:</b> ${esc(pokes)}
        <br/><a href='${esc(d.detail_url)}' target='_blank' rel='noopener'>📝 詳細</a>${overlap?'<br/><span class="stat-inline">※ 座標重複</span>':''}
      </div>`;
    }

    function recomputeVisibility(){
      const showPokemon = document.getElementById('chk-pokemon')?.checked;
      const showGundam = document.getElementById('chk-gundam')?.checked;
      let visible=0, gCount=0, pCount=0;
      
      allMarkers.forEach(m=>{
        const d = m._data; 
        let show = true;
        
        // Simple franchise filter
        if(d.franchise==='gundam'){ 
          show = showGundam; 
        } else { 
          show = showPokemon; 
        }
        
        if(show){ 
          if(!map.hasLayer(m)) m.addTo(map); 
          visible++; 
          if(d.franchise==='gundam') gCount++; 
          else pCount++; 
        } else { 
          if(map.hasLayer(m)) map.removeLayer(m); 
        }
      });
      updateStats(visible, gCount, pCount);
    }

    function updateStats(visibleOverride, gCountOverride, pCountOverride){
      const totalEl=document.querySelector('#total-count span');
      const visEl=document.querySelector('#visible-count span');
      const gEl=document.querySelector('#gundam-count span');
      const pEl=document.querySelector('#pokemon-count span');
      if(totalEl) totalEl.textContent=String(allMarkers.length);
      if(visEl) visEl.textContent=String(visibleOverride ?? allMarkers.length);
      if(gEl) gEl.textContent=String(gCountOverride ?? gundamData.length);
      if(pEl) pEl.textContent=String(pCountOverride ?? pokemonData.length);
    }

    // Event listeners
    document.getElementById('chk-pokemon').addEventListener('change', recomputeVisibility);
    document.getElementById('chk-gundam').addEventListener('change', recomputeVisibility);

    loadDatasets();
  </script>
</body>
</html>