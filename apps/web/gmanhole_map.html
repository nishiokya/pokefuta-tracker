<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚¬ãƒ³ãƒ€ãƒ  & ãƒã‚±ãµãŸ ãƒãƒ³ãƒ›ãƒ¼ãƒ«ãƒãƒƒãƒ— | è–åœ°å·¡ç¤¼æ”¯æ´</title>
  <meta name="description" content="ã‚¬ãƒ³ãƒ€ãƒ ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã¨ãƒã‚±ãµãŸã‚’1æšã®åœ°å›³ã§çµ±åˆè¡¨ç¤ºã€‚ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ãƒã‚±ãƒ¢ãƒ³ãƒ»é‡è¤‡åœ°ç‚¹ã‚’å¯è¦–åŒ–ã—è–åœ°å·¡ç¤¼è¨ˆç”»ã«æ´»ç”¨ã€‚">
  <meta name="keywords" content="ã‚¬ãƒ³ãƒ€ãƒ ãƒãƒ³ãƒ›ãƒ¼ãƒ«,ãƒã‚±ãµãŸ,ãƒãƒ³ãƒ›ãƒ¼ãƒ«,ã‚¬ãƒ³ãƒ€ãƒ ,ãƒã‚±ãƒ¢ãƒ³,è–åœ°å·¡ç¤¼,åœ°å›³">
  <meta name="robots" content="index,follow">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ja_JP">
  <meta property="og:title" content="ã‚¬ãƒ³ãƒ€ãƒ  & ãƒã‚±ãµãŸ ãƒãƒ³ãƒ›ãƒ¼ãƒ«ãƒãƒƒãƒ— | è–åœ°å·¡ç¤¼æ”¯æ´">
  <meta property="og:description" content="ã‚¬ãƒ³ãƒ€ãƒ ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã¨ãƒã‚±ãµãŸã‚’çµ±åˆã€‚ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚„ãƒã‚±ãƒ¢ãƒ³ã§ãƒ•ã‚£ãƒ«ã‚¿å¯èƒ½ã€‚">
  <meta property="og:url" content="https://nishiokya.github.io/pokefuta-tracker/gmanhole_map.html">
  <meta property="og:image" content="https://nishiokya.github.io/pokefuta-tracker/assets/manhole_icon.png">
  <link rel="canonical" href="https://nishiokya.github.io/pokefuta-tracker/gmanhole_map.html">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="./assets/theme.css" />
  <link rel="stylesheet" href="./assets/map.css" />
  <style>
    /* Franchise specific marker styling (DivIcon) */
    .fr-marker { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:15px; font-weight:600; color:#fff; box-shadow:0 0 0 2px #fff, 0 2px 6px rgba(0,0,0,.35); }
    .fr-pokemon { background:linear-gradient(135deg,#ffcc00,#ff6b00); }
    .fr-gundam { background:linear-gradient(135deg,#0044aa,#cc0000); }
    .fr-both { background:linear-gradient(135deg,#6a00cc,#ff0066); }
    #controls { max-width:340px; }
    .legend { margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:4px; font-size:0.75rem; }
    .legend-swatch { width:18px; height:18px; border-radius:50%; box-shadow:0 0 0 1px #fff,0 1px 3px rgba(0,0,0,.3); }
    .legend-pokemon { background:linear-gradient(135deg,#ffcc00,#ff6b00); }
    .legend-gundam { background:linear-gradient(135deg,#0044aa,#cc0000); }
    .legend-both { background:linear-gradient(135deg,#6a00cc,#ff0066); }
    .character-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(90px,1fr)); gap:4px; margin-top:4px; max-height:220px; overflow:auto; }
    .character-item { background:#f5f7fa; border:1px solid #dde; padding:4px 6px; border-radius:6px; cursor:pointer; font-size:0.7rem; display:flex; flex-direction:column; gap:2px; }
    .character-item.selected { background:#334; color:#fff; }
    .character-count { font-size:0.65rem; opacity:0.7; }
    .franchise-filter-group { display:flex; gap:8px; flex-wrap:wrap; margin:4px 0 8px; }
    .franchise-filter-group label { font-size:0.8rem; cursor:pointer; display:flex; align-items:center; gap:4px; }
    .dataset-summary { font-size:0.65rem; color:#555; margin-top:4px; }
    .popup-box { font-size:0.8rem; line-height:1.2; }
    .popup-box .popup-title { font-weight:600; }
    .stat-inline { font-size:0.7rem; color:#444; margin:2px 0; }
    .filter-section { margin-bottom:10px; }
  </style>
  <link rel="icon" href="./assets/manhole_icon.png" type="image/png" />
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K18NR4GZG2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
    gtag('config', 'G-K18NR4GZG2', { 'anonymize_ip': true });
  </script>
  <!-- End GA -->
</head>
<body>
  <div id="controls" role="complementary" aria-labelledby="page-title">
    <div class="controls-header">
      <h3 id="page-title">ğŸ•³ ã‚¬ãƒ³ãƒ€ãƒ  & ãƒã‚±ãµãŸ ãƒãƒƒãƒ—</h3>
  <a href="./" class="nav-link" style="margin-right: 8px;">â† ãƒã‚±ãµãŸãƒãƒƒãƒ—</a>
  <a href="./nearby_manholes.html" class="nav-link" id="nav-link">ğŸ“ è¿‘ãã®ãƒãƒ³ãƒ›ãƒ¼ãƒ«</a>
    </div>
    <div class="controls-content" role="region" aria-label="Filters and statistics">
      <div class="filter-section">
        <h4 style="margin:4px 0;">è¡¨ç¤ºè¨­å®š</h4>
        <div class="franchise-filter-group" role="group" aria-label="Franchise filters">
          <label><input type="checkbox" id="chk-pokemon" checked aria-label="ãƒã‚±ãƒ¢ãƒ³è¡¨ç¤º" /> ãƒã‚±ãƒ¢ãƒ³</label>
          <label><input type="checkbox" id="chk-gundam" checked aria-label="ã‚¬ãƒ³ãƒ€ãƒ è¡¨ç¤º" /> ã‚¬ãƒ³ãƒ€ãƒ </label>
        </div>
        <div class="legend" aria-label="Legend">
          <div class="legend-item"><span class="legend-swatch legend-pokemon"></span>ãƒã‚±ãµãŸ</div>
          <div class="legend-item"><span class="legend-swatch legend-gundam"></span>ã‚¬ãƒ³ãƒ€ãƒ </div>
          <div class="legend-item"><span class="legend-swatch legend-both"></span>åº§æ¨™å…±æœ‰/é‡è¤‡</div>
        </div>
      </div>
      <div class="filter-section">
        <h4 style="margin:4px 0;">éƒ½é“åºœçœŒåˆ¥ä»¶æ•°</h4>
        <div id="prefecture-counts" style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></div>
      </div>
      <div class="stats" role="status" aria-live="polite">
        <div id="total-count">ç·æ•°: <span>0</span></div>
        <div id="visible-count">è¡¨ç¤º: <span>0</span></div>
        <div id="gundam-count">ã‚¬ãƒ³ãƒ€ãƒ : <span>0</span></div>
        <div id="pokemon-count">ãƒã‚±ãµãŸ: <span>0</span></div>
      </div>
    </div>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([36.0, 138.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    function franchiseIcon(franchise, overlap=false) {
      let cls = 'fr-marker ';
      if (overlap) cls += 'fr-both';
      else if (franchise === 'gundam') cls += 'fr-gundam';
      else if (franchise === 'pokefuta' || franchise === 'pokemon') cls += 'fr-pokemon';
      else cls += 'fr-pokemon';
      const label = overlap ? 'â—' : (franchise === 'gundam' ? 'G' : 'P');
      return L.divIcon({ className: cls, html: label, iconSize: [30,30], iconAnchor:[15,15], popupAnchor:[0,-15] });
    }

    // Data containers
    let gundamData = []; // gmanhole
    let pokemonData = []; // pokefuta
    let allMarkers = [];

    // éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°
    const prefectureCodeMap = {
      'åŒ—æµ·é“': '01', 'é’æ£®çœŒ': '02', 'å²©æ‰‹çœŒ': '03', 'å®®åŸçœŒ': '04', 'ç§‹ç”°çœŒ': '05',
      'å±±å½¢çœŒ': '06', 'ç¦å³¶çœŒ': '07', 'èŒ¨åŸçœŒ': '08', 'æ ƒæœ¨çœŒ': '09', 'ç¾¤é¦¬çœŒ': '10',
      'åŸ¼ç‰çœŒ': '11', 'åƒè‘‰çœŒ': '12', 'æ±äº¬éƒ½': '13', 'ç¥å¥ˆå·çœŒ': '14', 'æ–°æ½ŸçœŒ': '15',
      'å¯Œå±±çœŒ': '16', 'çŸ³å·çœŒ': '17', 'ç¦äº•çœŒ': '18', 'å±±æ¢¨çœŒ': '19', 'é•·é‡çœŒ': '20',
      'å²é˜œçœŒ': '21', 'é™å²¡çœŒ': '22', 'æ„›çŸ¥çœŒ': '23', 'ä¸‰é‡çœŒ': '24', 'æ»‹è³€çœŒ': '25',
      'äº¬éƒ½åºœ': '26', 'å¤§é˜ªåºœ': '27', 'å…µåº«çœŒ': '28', 'å¥ˆè‰¯çœŒ': '29', 'å’Œæ­Œå±±çœŒ': '30',
      'é³¥å–çœŒ': '31', 'å³¶æ ¹çœŒ': '32', 'å²¡å±±çœŒ': '33', 'åºƒå³¶çœŒ': '34', 'å±±å£çœŒ': '35',
      'å¾³å³¶çœŒ': '36', 'é¦™å·çœŒ': '37', 'æ„›åª›çœŒ': '38', 'é«˜çŸ¥çœŒ': '39', 'ç¦å²¡çœŒ': '40',
      'ä½è³€çœŒ': '41', 'é•·å´çœŒ': '42', 'ç†Šæœ¬çœŒ': '43', 'å¤§åˆ†çœŒ': '44', 'å®®å´çœŒ': '45',
      'é¹¿å…å³¶çœŒ': '46', 'æ²–ç¸„çœŒ': '47'
    };

    async function loadDatasets(){
      try {
        // Try multiple potential paths for pokefuta data
        const pokefutaPaths = [
          './pokefuta.ndjson',  // Current relative path
          'pokefuta.ndjson',    // Direct filename
          '../pokefuta.ndjson', // Parent directory
          'https://raw.githubusercontent.com/nishiokya/pokefuta-tracker/main/docs/pokefuta.ndjson' // Fallback to GitHub raw
        ];
        
        let pRes = null;
        for (const path of pokefutaPaths) {
          try {
            console.log(`Trying to fetch pokefuta data from: ${path}`);
            pRes = await fetch(path);
            if (pRes.ok) {
              console.log(`Successfully loaded pokefuta data from: ${path}`);
              break;
            }
          } catch (e) {
            console.warn(`Failed to fetch from ${path}:`, e);
          }
        }
        
        if (!pRes || !pRes.ok) {
          throw new Error('Could not load pokefuta data from any path');
        }
        
        const [gRes] = await Promise.all([
          fetch('./assets/gmanhole.ndjson')
        ]);
        
        gundamData = await parseNdjson(gRes);
        pokemonData = await parseNdjson(pRes);
        buildMarkers();
        buildPrefectureCounts();
        updateStats();
      } catch(e){ console.error('Failed to load datasets', e); }
    }

    async function parseNdjson(response){
      const text = await response.text();
      return text.trim().split('\n').filter(Boolean).map(line => {
        try { return JSON.parse(line); } catch { return null; }
      }).filter(Boolean);
    }

    function buildMarkers() {
      allMarkers.forEach(m => { if (map.hasLayer(m)) map.removeLayer(m); });
      allMarkers = [];
      // Determine overlaps -> same lat/lng (rounded) between franchises
      const locKey = d => d.lat != null && d.lng != null ? (d.lat.toFixed(5)+'|'+d.lng.toFixed(5)) : null;
      const pokemonLocs = new Set(pokemonData.map(locKey).filter(Boolean));
      const gundamLocs = new Set(gundamData.map(locKey).filter(Boolean));
      const overlapLocs = new Set([...pokemonLocs].filter(k => gundamLocs.has(k)));

      gundamData.forEach(d => {
        if (d.lat == null || d.lng == null) return; // skip unless geocoded
        const overlap = overlapLocs.has(locKey(d));
        const popup = buildGundamPopup(d, overlap);
        const marker = L.marker([d.lat, d.lng], { icon: franchiseIcon('gundam', overlap) }).bindPopup(popup);
        marker._data = { ...d, franchise:'gundam', overlap };
        marker.addTo(map); allMarkers.push(marker);
      });
      pokemonData.forEach(d => {
        if (d.lat == null || d.lng == null) return;
        const overlap = overlapLocs.has(locKey(d));
        const popup = buildPokemonPopup(d, overlap);
        const marker = L.marker([d.lat, d.lng], { icon: franchiseIcon('pokefuta', overlap) }).bindPopup(popup);
        marker._data = { ...d, franchise:'pokefuta', overlap };
        marker.addTo(map); allMarkers.push(marker);
      });
      recomputeVisibility();
    }

    function buildPrefectureCounts() {
      const container = document.getElementById('prefecture-counts');
      if (!container) return;

      const counts = {};
      
      // Count Gundam manholes by prefecture
      gundamData.forEach(d => {
        const pref = d.prefecture || 'ä¸æ˜';
        if (!counts[pref]) counts[pref] = { gundam: 0, pokemon: 0 };
        counts[pref].gundam++;
      });

      // Count Pokemon manholes by prefecture
      pokemonData.forEach(d => {
        const pref = d.prefecture || 'ä¸æ˜';
        if (!counts[pref]) counts[pref] = { gundam: 0, pokemon: 0 };
        counts[pref].pokemon++;
      });

      // Sort prefectures by prefecture code order
      const sortedPrefectures = Object.entries(counts)
        .sort(([a], [b]) => {
          const codeA = prefectureCodeMap[a] || '99'; // 'ä¸æ˜' gets '99'
          const codeB = prefectureCodeMap[b] || '99';
          return codeA.localeCompare(codeB);
        });

      container.innerHTML = sortedPrefectures.map(([pref, count]) => {
        const total = count.gundam + count.pokemon;
        const prefCode = prefectureCodeMap[pref] || '--';
        const gundamText = count.gundam > 0 ? `ã‚¬ãƒ³ãƒ€ãƒ : ${count.gundam}` : '';
        const pokemonText = count.pokemon > 0 ? `ãƒã‚±ãƒ¢ãƒ³: ${count.pokemon}` : '';
        const details = [gundamText, pokemonText].filter(Boolean).join(', ');
        
        return `<div style="padding: 2px 0; border-bottom: 1px solid #eee;">
          <div style="font-weight: 600;">${prefCode} ${pref} (${total}ä»¶)</div>
          <div style="font-size: 0.75rem; color: #666; margin-left: 8px;">${details}</div>
        </div>`;
      }).join('');
    }

    function buildMarkers() {
      allMarkers.forEach(m => { if (map.hasLayer(m)) map.removeLayer(m); });
      allMarkers = [];
      // Determine overlaps -> same lat/lng (rounded) between franchises
      const locKey = d => d.lat != null && d.lng != null ? (d.lat.toFixed(5)+'|'+d.lng.toFixed(5)) : null;
      const pokemonLocs = new Set(pokemonData.map(locKey).filter(Boolean));
      const gundamLocs = new Set(gundamData.map(locKey).filter(Boolean));
      const overlapLocs = new Set([...pokemonLocs].filter(k => gundamLocs.has(k)));

      gundamData.forEach(d => {
        if (d.lat == null || d.lng == null) return; // skip unless geocoded
        const overlap = overlapLocs.has(locKey(d));
        const popup = buildGundamPopup(d, overlap);
        const marker = L.marker([d.lat, d.lng], { icon: franchiseIcon('gundam', overlap) }).bindPopup(popup);
        marker._data = { ...d, franchise:'gundam', overlap };
        marker.addTo(map); allMarkers.push(marker);
      });
      pokemonData.forEach(d => {
        if (d.lat == null || d.lng == null) return;
        const overlap = overlapLocs.has(locKey(d));
        const popup = buildPokemonPopup(d, overlap);
        const marker = L.marker([d.lat, d.lng], { icon: franchiseIcon('pokefuta', overlap) }).bindPopup(popup);
        marker._data = { ...d, franchise:'pokefuta', overlap };
        marker.addTo(map); allMarkers.push(marker);
      });
      recomputeVisibility();
    }

    function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function buildGundamPopup(d, overlap){
      const chars = Array.isArray(d.characters)&&d.characters.length ? d.characters.join(', ') : 'â€”';
      const series = d.series || 'â€”';
      const imgs = Array.isArray(d.image_urls)&&d.image_urls.length ? `<div style='margin-top:4px;'>ç”»åƒ:${d.images_count}</div>`:'<div style="margin-top:4px;">ç”»åƒãªã—</div>';
      return `<div class='popup-box'>
        <b>ID:</b> ${esc(d.id)}<br/><b>ã‚¿ã‚¤ãƒˆãƒ«:</b> <span class='popup-title'>${esc(d.title)}</span><br/>
        <b>éƒ½é“åºœçœŒ:</b> ${esc(d.prefecture||'')} / ${esc(d.city||'')}<br/>
        <b>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:</b> ${esc(chars)}<br/><b>ã‚·ãƒªãƒ¼ã‚º:</b> ${esc(series)}${imgs}
        <br/><a href='${esc(d.detail_url)}' target='_blank' rel='noopener'>ğŸ“ è©³ç´°</a>${overlap?'<br/><span class="stat-inline">â€» åº§æ¨™é‡è¤‡</span>':''}
      </div>`;
    }

    function buildPokemonPopup(d, overlap){
      const pokes = Array.isArray(d.pokemons)&&d.pokemons.length ? d.pokemons.join(', ') : 'â€”';
      return `<div class='popup-box'>
        <b>ID:</b> ${esc(d.id)}<br/><b>ã‚¿ã‚¤ãƒˆãƒ«:</b> <span class='popup-title'>${esc(d.title)}</span><br/>
        <b>éƒ½é“åºœçœŒ:</b> ${esc(d.prefecture||'')} / ${esc(d.city||'')}<br/>
        <b>ãƒã‚±ãƒ¢ãƒ³:</b> ${esc(pokes)}
        <br/><a href='${esc(d.detail_url)}' target='_blank' rel='noopener'>ğŸ“ è©³ç´°</a>${overlap?'<br/><span class="stat-inline">â€» åº§æ¨™é‡è¤‡</span>':''}
      </div>`;
    }

    function buildPokemonPopup(d, overlap){
      const pokes = Array.isArray(d.pokemons)&&d.pokemons.length ? d.pokemons.join(', ') : 'â€”';
      return `<div class='popup-box'>
        <b>ID:</b> ${esc(d.id)}<br/><b>ã‚¿ã‚¤ãƒˆãƒ«:</b> <span class='popup-title'>${esc(d.title)}</span><br/>
        <b>éƒ½é“åºœçœŒ:</b> ${esc(d.prefecture||'')} / ${esc(d.city||'')}<br/>
        <b>ãƒã‚±ãƒ¢ãƒ³:</b> ${esc(pokes)}
        <br/><a href='${esc(d.detail_url)}' target='_blank' rel='noopener'>ğŸ“ è©³ç´°</a>${overlap?'<br/><span class="stat-inline">â€» åº§æ¨™é‡è¤‡</span>':''}
      </div>`;
    }

    function recomputeVisibility(){
      const showPokemon = document.getElementById('chk-pokemon')?.checked;
      const showGundam = document.getElementById('chk-gundam')?.checked;
      let visible=0, gCount=0, pCount=0;
      
      allMarkers.forEach(m=>{
        const d = m._data; 
        let show = true;
        
        // Simple franchise filter
        if(d.franchise==='gundam'){ 
          show = showGundam; 
        } else { 
          show = showPokemon; 
        }
        
        if(show){ 
          if(!map.hasLayer(m)) m.addTo(map); 
          visible++; 
          if(d.franchise==='gundam') gCount++; 
          else pCount++; 
        } else { 
          if(map.hasLayer(m)) map.removeLayer(m); 
        }
      });
      updateStats(visible, gCount, pCount);
    }

    function updateStats(visibleOverride, gCountOverride, pCountOverride){
      const totalEl=document.querySelector('#total-count span');
      const visEl=document.querySelector('#visible-count span');
      const gEl=document.querySelector('#gundam-count span');
      const pEl=document.querySelector('#pokemon-count span');
      if(totalEl) totalEl.textContent=String(allMarkers.length);
      if(visEl) visEl.textContent=String(visibleOverride ?? allMarkers.length);
      if(gEl) gEl.textContent=String(gCountOverride ?? gundamData.length);
      if(pEl) pEl.textContent=String(pCountOverride ?? pokemonData.length);
    }

    // Event listeners
    document.getElementById('chk-pokemon').addEventListener('change', recomputeVisibility);
    document.getElementById('chk-gundam').addEventListener('change', recomputeVisibility);

    loadDatasets();
  </script>
</body>
</html>