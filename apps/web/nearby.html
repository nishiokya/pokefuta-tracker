<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>近くのポケふた</title>
  <meta name="description" content="現在地から近いポケふたを距離順に表示します" />
  <style>
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#ff6b6b 0%,#4ecdc4 50%,#ffe66d 100%);} 
    .container{max-width:800px;margin:0 auto;padding:20px;} .header{text-align:center;color:#fff;margin-bottom:30px;} .header h1{margin:0 0 8px;font-size:2.2em;text-shadow:2px 2px 4px rgba(0,0,0,.3);} 
    .nav-back{display:inline-block;background:rgba(255,255,255,.2);color:#fff;text-decoration:none;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600;margin-top:10px;border:1px solid rgba(255,255,255,.3);transition:.3s;} .nav-back:hover{background:rgba(255,255,255,.3);transform:translateY(-1px);} 
    .location-status,.distance-filter{background:rgba(255,255,255,.9);padding:15px;border-radius:10px;margin-bottom:20px;} .location-status{text-align:center;font-weight:700;} 
    .location-button{background:#ff6b6b;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;transition:.3s;box-shadow:0 4px 12px rgba(0,0,0,.2);} .location-button:hover{background:#ff5252;transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.3);} 
    .distance-filter label{font-weight:700;margin-right:10px;} .distance-filter select{padding:8px 12px;border-radius:5px;border:2px solid #ddd;font-size:14px;} 
    .manhole-list{background:rgba(255,255,255,.95);border-radius:15px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,.2);} .manhole-item{border-bottom:1px solid #eee;padding:20px 0;display:flex;justify-content:space-between;align-items:flex-start;gap:16px;} .manhole-item:last-child{border-bottom:none;} 
    .manhole-info{flex:1;} .manhole-title{font-size:18px;font-weight:700;color:#333;margin:0 0 6px;} .manhole-location{color:#666;margin:0 0 5px;font-size:14px;} .manhole-pokemon{background:#4ecdc4;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;display:inline-block;margin:4px 5px 0 0;} 
    .manhole-actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end;} .manhole-distance{background:#ffe66d;color:#333;padding:8px 12px;border-radius:20px;font-weight:700;font-size:14px;min-width:80px;text-align:center;} 
    .maps-link,.pokefuta-link{background:#4285f4;color:#fff;text-decoration:none;padding:6px 12px;border-radius:15px;font-size:12px;font-weight:600;transition:.3s;display:inline-block;} .maps-link:hover{background:#3367d6;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.2);} .pokefuta-link{background:#ff6b35;} .pokefuta-link:hover{background:#e55a2b;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.2);} 
    .loading{text-align:center;padding:40px;color:#666;} .error{background:#ffebee;color:#c62828;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center;font-size:14px;} .no-results{text-align:center;padding:40px;color:#666;font-size:18px;} 
    @media (max-width:600px){.container{padding:10px;} .header h1{font-size:1.9em;} .manhole-item{flex-direction:column;align-items:stretch;} .manhole-actions{align-items:flex-start;flex-direction:row;flex-wrap:wrap;} .manhole-distance{order:-1;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🕳️ 近くのポケふた</h1>
      <p style="margin:0 0 4px;">現在地から近い順にポケふたを表示します。</p>
      <a class="nav-back" href="/pokefuta-tracker/">🗾 マップに戻る</a>
    </div>
    <div id="locationStatus" class="location-status">
      <button class="location-button" onclick="getCurrentLocation()">📍 現在地を取得</button>
    </div>
    <div id="distanceFilter" class="distance-filter" style="display:none;">
      <label for="distanceSelect">表示範囲:</label>
      <select id="distanceSelect" onchange="filterManholes()">
        <option value="1">1km以内</option>
        <option value="3">3km以内</option>
        <option value="5">5km以内</option>
        <option value="10">10km以内</option>
        <option value="20">20km以内</option>
        <option value="50">50km以内</option>
        <option value="999999" selected>すべて</option>
      </select>
    </div>
    <div id="manholeList" class="manhole-list"><div class="loading">位置情報を取得してマンホールを表示します</div></div>
  </div>
  <script>
    let allManholes=[];let userLocation=null;
    const calcDist=(a,b,c,d)=>{const R=6371;const dLat=(c-a)*Math.PI/180;const dLng=(d-b)*Math.PI/180;const e=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2;return 2*R*Math.atan2(Math.sqrt(e),Math.sqrt(1-e));};
    const fmtDist=km=>km<1?Math.round(km*1000)+'m':km.toFixed(1)+'km';
    function getCurrentLocation(){const el=document.getElementById('locationStatus');el.innerHTML='<div style="color:#666;">📍 位置情報を取得中...</div>';if(!navigator.geolocation){el.innerHTML='<div class="error">このブラウザは位置情報に対応していません</div>';return;}navigator.geolocation.getCurrentPosition(p=>{userLocation={lat:p.coords.latitude,lng:p.coords.longitude};el.innerHTML='<div style="color:#4caf50;">✅ 位置情報を取得しました</div>';document.getElementById('distanceFilter').style.display='block';loadManholes();},err=>{let m='位置情報の取得に失敗しました';if(err.code===err.PERMISSION_DENIED)m='位置情報へのアクセスが拒否されました';else if(err.code===err.POSITION_UNAVAILABLE)m='位置情報が利用できません';else if(err.code===err.TIMEOUT)m='位置情報の取得がタイムアウトしました';el.innerHTML=`<div class="error">${m}</div><button class="location-button" onclick="getCurrentLocation()" style="margin-top:10px;">再試行</button>`;},{enableHighAccuracy:true,timeout:10000,maximumAge:300000});}
    async function loadManholes(){const list=document.getElementById('manholeList');list.innerHTML='<div class="loading">マンホールデータを読み込み中...</div>';try{const res=await fetch('./pokefuta.ndjson');const text=await res.text();const lines=text.trim().split('\n');const map=new Map();for(const line of lines){if(!line.trim())continue;const m=JSON.parse(line);if(!map.has(m.id)||new Date(m.source_last_checked)>new Date(map.get(m.id).source_last_checked))map.set(m.id,m);}allManholes=[...map.values()];for(const m of allManholes){if(userLocation){m.distance=calcDist(userLocation.lat,userLocation.lng,m.lat,m.lng);}}filterManholes();}catch(e){console.error(e);list.innerHTML='<div class="error">マンホールデータの読み込みに失敗しました</div>';}}
    function filterManholes(){const list=document.getElementById('manholeList');const max=parseFloat(document.getElementById('distanceSelect').value);if(!userLocation||!allManholes.length)return;const filtered=allManholes.filter(m=>m.distance<=max).sort((a,b)=>a.distance-b.distance);if(!filtered.length){list.innerHTML='<div class="no-results">指定範囲内にマンホールがありません</div>';return;}list.innerHTML=filtered.map(m=>{const maps=`https://www.google.com/maps?q=${m.lat},${m.lng}`;const detail=`https://local.pokemon.jp/manhole/detail/${m.id}/`;return `<div class="manhole-item"><div class="manhole-info"><div class="manhole-title">${m.title||`マンホール #${m.id}`}</div><div class="manhole-location">📍 ${m.prefecture} ${m.city}</div><div>${m.pokemons.map(p=>`<span class=\"manhole-pokemon\">${p}</span>`).join('')}</div></div><div class="manhole-actions"><div class="manhole-distance">${fmtDist(m.distance)}</div><a class="pokefuta-link" target="_blank" href="${detail}">⚡ 公式情報</a><a class="maps-link" target="_blank" href="${maps}">📍 Google Map</a></div></div>`;}).join('');}
    document.addEventListener('DOMContentLoaded',()=>{if(navigator.geolocation&&navigator.permissions){navigator.permissions.query({name:'geolocation'}).then(r=>{if(r.state==='granted')getCurrentLocation();}).catch(()=>{});}});
  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LX58JGRPNV"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-LX58JGRPNV');</script>
</body>
</html>
