<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>近くのポケふた</title>
  <meta name="description" content="現在地から近いポケふたを距離順に表示します" />
  <link rel="stylesheet" href="./assets/theme.css" />
  <style>
    .container { max-width:880px; margin:0 auto; }
    .header { text-align:center; margin:0 0 28px; position:relative; }
    .header h1 { margin:0 0 6px; font-size:clamp(1.9rem,4.5vw,3rem); line-height:1.05; letter-spacing:1px; display:inline-block; padding:10px 18px 12px; background:var(--theme-cloth-alt); border:var(--border-thick) solid var(--theme-shadow); box-shadow:var(--shadow-offset) var(--shadow-offset) 0 0 var(--theme-shadow); font-weight:800; }
    .header p { margin:14px auto 0; max-width:460px; font-size:.95rem; font-weight:600; background:var(--theme-accent2); padding:10px 14px; border:var(--border-thick) solid var(--theme-shadow); box-shadow:5px 5px 0 0 var(--theme-shadow); }
    .nav-back { margin-top:18px; text-decoration:none; padding:10px 20px; display:inline-block; font-weight:700; background:var(--theme-accent); color:#fff; font-size:.85rem; text-transform:uppercase; letter-spacing:.5px; border:var(--border-thick) solid var(--theme-shadow); box-shadow:var(--shadow-offset) var(--shadow-offset) 0 0 var(--theme-shadow); }
    .nav-back:hover { transform: translate(calc(var(--shadow-offset)*-0.15), calc(var(--shadow-offset)*-0.15)); box-shadow: calc(var(--shadow-offset)*0.6) calc(var(--shadow-offset)*0.6) 0 0 var(--theme-shadow); }
    .layout-grid { display:grid; gap:28px; }
    .location-status, .distance-filter { padding:18px 20px 20px; }
    .location-status, .distance-filter, .manhole-item { background:var(--theme-cloth); border:var(--border-thick) solid var(--theme-shadow); box-shadow:var(--shadow-offset) var(--shadow-offset) 0 0 var(--theme-shadow); }
    select { font: inherit; padding:10px 14px; background:var(--theme-cloth-alt); border:var(--border-thick) solid var(--theme-shadow); }
    select:focus { outline:4px solid var(--theme-accent2); }
  .location-button { cursor:pointer; font-weight:800; font-size:1rem; padding:14px 36px; border-radius:0; background:var(--theme-accent); color:#fff; border:var(--border-thick) solid var(--theme-shadow); box-shadow: var(--shadow-offset) var(--shadow-offset) 0 0 var(--theme-shadow); text-transform:uppercase; letter-spacing:1px; }
  .location-button:hover { background:var(--theme-accent2); color:#111; }
    .manhole-list { display:flex; flex-direction:column; gap:26px; margin-top:4px; }
    .manhole-item { padding:20px 22px 18px; display:flex; gap:22px; align-items:flex-start; flex-wrap:wrap; background:var(--theme-cloth-alt); }
    .manhole-info { flex:1 1 320px; min-width:260px; }
    .manhole-title { margin:0 0 4px; font-size:1.15rem; font-weight:800; letter-spacing:.5px; }
    .manhole-location { margin:0 0 8px; font-size:.8rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:#444; }
  .manhole-pokemon { background:var(--theme-tag); color:#fff; padding:6px 10px 5px; border:var(--border-thick) solid var(--theme-shadow); font-size:.7rem; font-weight:800; letter-spacing:.5px; display:inline-block; margin:4px 8px 0 0; box-shadow:3px 3px 0 0 var(--theme-shadow); text-transform:uppercase; }
    .manhole-pokemon:nth-child(odd){ background:var(--theme-accent); }
    .manhole-actions { display:flex; flex-direction:column; gap:10px; align-items:flex-end; justify-content:space-between; }
  .manhole-distance { background:var(--theme-accent2); color:#111; padding:10px 18px 8px; font-weight:900; font-size:.85rem; border:var(--border-thick) solid var(--theme-shadow); letter-spacing:1px; box-shadow:4px 4px 0 0 var(--theme-shadow); }
  .maps-link, .pokefuta-link { text-decoration:none; padding:10px 16px 9px; font-size:.7rem; font-weight:800; text-transform:uppercase; letter-spacing:1px; border:var(--border-thick) solid var(--theme-shadow); box-shadow:4px 4px 0 0 var(--theme-shadow); background:var(--theme-accent); color:#fff; display:inline-flex; align-items:center; gap:6px; }
    .pokefuta-link { background:var(--theme-accent2); color:#111; }
    .pokefuta-link:hover { background:var(--theme-accent); color:#fff; }
  .loading { text-align:center; padding:60px 10px; border:var(--border-thick) dashed var(--theme-shadow); background:var(--theme-cloth-alt); font-weight:700; }
  .no-results { text-align:center; padding:50px 10px; background:var(--theme-cloth-alt); border:var(--border-thick) solid var(--theme-shadow); box-shadow:var(--shadow-offset) var(--shadow-offset) 0 0 var(--theme-shadow); font-weight:700; }
  .error { background:#FDE4E4; color:var(--theme-shadow); padding:18px 20px; border:var(--border-thick) solid var(--theme-danger); box-shadow:6px 6px 0 0 var(--theme-shadow); font-weight:700; }
    @media (min-width:860px) { .layout-grid { grid-template-columns: 300px 1fr; align-items:start; } .panel-stack { position:sticky; top:20px; } }
    @media (max-width:640px) { body { padding:12px; } .manhole-item { padding:18px 18px 16px; } .manhole-actions { width:100%; flex-direction:row; flex-wrap:wrap; align-items:flex-start; } .manhole-distance { order:-1; margin-bottom:4px; } }
  </style>
</head>
<body>
  <div class="container layout-grid">
    <div class="panel-stack" aria-labelledby="panel-title">
      <div class="header">
        <h1 id="panel-title">🕳️ 近くのポケふた</h1>
  <p>現在地から近い順にポケふたを表示。</p>
        <a class="nav-back" href="/pokefuta-tracker/">マップへ戻る</a>
      </div>
      <div id="locationStatus" class="location-status nb-card" role="status" aria-live="polite">
        <button class="location-button">📍 現在地を取得</button>
      </div>
      <div id="distanceFilter" class="distance-filter nb-card" style="display:none;">
        <label for="distanceSelect">表示範囲 (距離フィルタ)</label>
        <select id="distanceSelect" onchange="filterManholes()" aria-label="距離フィルタ">
          <option value="1">1km以内</option>
          <option value="3">3km以内</option>
          <option value="5">5km以内</option>
          <option value="10">10km以内</option>
          <option value="20">20km以内</option>
          <option value="50">50km以内</option>
          <option value="999999" selected>すべて</option>
        </select>
      </div>
    </div>
  <div id="manholeList" class="manhole-list" aria-live="polite" aria-busy="true" role="status"><div class="loading-box">位置情報を取得してマンホールを表示します</div></div>
  </div>
  <script>
    let allManholes=[];let userLocation=null;
    const calcDist=(a,b,c,d)=>{const R=6371;const dLat=(c-a)*Math.PI/180;const dLng=(d-b)*Math.PI/180;const e=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2;return 2*R*Math.atan2(Math.sqrt(e),Math.sqrt(1-e));};
    const fmtDist=km=>km<1?Math.round(km*1000)+'m':km.toFixed(1)+'km';
  function getCurrentLocation(){const el=document.getElementById('locationStatus');el.setAttribute('aria-busy','true');el.innerHTML='<div class="loading-box">📍 位置情報を取得中...</div>';if(!navigator.geolocation){el.innerHTML='<div class="error-box" role="alert">このブラウザは位置情報に対応していません</div>';el.removeAttribute('aria-busy');return;}navigator.geolocation.getCurrentPosition(p=>{userLocation={lat:p.coords.latitude,lng:p.coords.longitude};el.innerHTML='<div class="success-box">✅ 位置情報を取得しました</div>';el.removeAttribute('aria-busy');document.getElementById('distanceFilter').style.display='block';loadManholes();},err=>{let m='位置情報の取得に失敗しました';if(err.code===err.PERMISSION_DENIED)m='位置情報へのアクセスが拒否されました';else if(err.code===err.POSITION_UNAVAILABLE)m='位置情報が利用できません';else if(err.code===err.TIMEOUT)m='位置情報の取得がタイムアウトしました';el.innerHTML=`<div class="error-box" role="alert">${m}</div><button class="location-button" onclick="getCurrentLocation()" style="margin-top:10px;">再試行</button>`;el.removeAttribute('aria-busy');},{enableHighAccuracy:true,timeout:10000,maximumAge:300000});}
  async function loadManholes(){const list=document.getElementById('manholeList');list.innerHTML='<div class="loading-box">マンホールデータを読み込み中...</div>';try{const res=await fetch('./pokefuta.ndjson');const text=await res.text();const lines=text.trim().split('\n');const map=new Map();for(const line of lines){if(!line.trim())continue;const m=JSON.parse(line);if(!map.has(m.id)||new Date(m.source_last_checked)>new Date(map.get(m.id).source_last_checked))map.set(m.id,m);}allManholes=[...map.values()];for(const m of allManholes){if(userLocation){m.distance=calcDist(userLocation.lat,userLocation.lng,m.lat,m.lng);}}filterManholes();}catch(e){console.error(e);list.innerHTML='<div class="error-box" role="alert">マンホールデータの読み込みに失敗しました</div>';}}
  function filterManholes(){const list=document.getElementById('manholeList');const max=parseFloat(document.getElementById('distanceSelect').value);if(!userLocation||!allManholes.length)return;const filtered=allManholes.filter(m=>m.distance<=max).sort((a,b)=>a.distance-b.distance);if(!filtered.length){list.innerHTML='<div class="no-results-box">指定範囲内にマンホールがありません</div>';return;}list.innerHTML=filtered.map(m=>{const maps=`https://www.google.com/maps?q=${m.lat},${m.lng}`;const detail=`https://local.pokemon.jp/manhole/detail/${m.id}/`;return `<div class="manhole-item"><div class="manhole-info"><div class="manhole-title">${m.title||`マンホール #${m.id}`}</div><div class="manhole-location">📍 ${m.prefecture} ${m.city}</div><div>${m.pokemons.map(p=>`<span class=\"manhole-pokemon\">${p}</span>`).join('')}</div></div><div class="manhole-actions"><div class="manhole-distance">${fmtDist(m.distance)}</div><a class="pokefuta-link" target="_blank" href="${detail}">⚡ 公式情報</a><a class="maps-link" target="_blank" href="${maps}">📍 Google Map</a></div></div>`;}).join('');}
  document.addEventListener('DOMContentLoaded',()=>{document.querySelector('#locationStatus .location-button').addEventListener('click',getCurrentLocation);if(navigator.geolocation&&navigator.permissions){navigator.permissions.query({name:'geolocation'}).then(r=>{if(r.state==='granted')getCurrentLocation();}).catch(()=>{});}});
  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LX58JGRPNV"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-LX58JGRPNV');</script>
</body>
</html>
