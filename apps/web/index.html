<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ãƒã‚±ãµãŸ ãƒãƒƒãƒ— | å…¨å›½ãƒã‚±ãƒ¢ãƒ³ãƒãƒ³ãƒ›ãƒ¼ãƒ«ä¸€è¦§</title>
  <meta name="description" content="å…¨å›½ã®ãƒã‚±ãƒ¢ãƒ³ãƒãƒ³ãƒ›ãƒ¼ãƒ«ï¼ˆãƒã‚±ãµãŸï¼‰ã‚’åœ°å›³ã§æ¢ç´¢ã€‚éƒ½é“åºœçœŒãƒ»ãƒã‚±ãƒ¢ãƒ³åãƒ»æœ€è¿‘è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ã§çµã‚Šè¾¼ã¿å¯èƒ½ã€‚">
  <meta name="keywords" content="ãƒã‚±ãµãŸ,ãƒã‚±ãƒ¢ãƒ³ãƒãƒ³ãƒ›ãƒ¼ãƒ«,ãƒãƒ³ãƒ›ãƒ¼ãƒ«,ãƒã‚±ãƒ¢ãƒ³,è–åœ°å·¡ç¤¼,åœ°å›³">
  <meta name="robots" content="index,follow">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="ja_JP">
  <meta property="og:title" content="ãƒã‚±ãµãŸ ãƒãƒƒãƒ— | å…¨å›½ãƒã‚±ãƒ¢ãƒ³ãƒãƒ³ãƒ›ãƒ¼ãƒ«ä¸€è¦§">
  <meta property="og:description" content="å…¨å›½ã®ãƒã‚±ãƒ¢ãƒ³ãƒãƒ³ãƒ›ãƒ¼ãƒ«ï¼ˆãƒã‚±ãµãŸï¼‰ã‚’åœ°å›³ã§æ¢ç´¢ã€‚è¨ªå•è¨ˆç”»ã‚„è–åœ°å·¡ç¤¼ã«æ´»ç”¨ã§ãã¾ã™ã€‚">
  <meta property="og:url" content="https://data.pokefuta.com/">
  <meta property="og:image" content="https://data.pokefuta.com/assets/pokefuta_icon_32.png">
  <link rel="canonical" href="https://data.pokefuta.com/">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="./assets/theme.css" />
  <link rel="stylesheet" href="./assets/map.css" />
  <link rel="icon" href="./assets/pokefuta_icon_32.png" type="image/png" />
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K18NR4GZG2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
    gtag('config', 'G-K18NR4GZG2', { 'anonymize_ip': true });
  </script>
  <!-- End GA -->
</head>
<body>
  <div id="controls" role="complementary" aria-labelledby="page-title">
    <div class="controls-header">
  <h3 id="page-title"><img src="./assets/manhole_icon.png" width="30" alt="ãƒãƒ³ãƒ›ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³">ãƒã‚±ãµãŸãƒãƒƒãƒ—</h3>
      <!-- è¨€èªåˆ‡æ›¿ãƒœã‚¿ãƒ³ã¯å»ƒæ­¢ï¼ˆå¤šè¨€èª UI éè¡¨ç¤ºï¼‰ã€‚å¿…è¦ã«ãªã‚Œã°å¾©æ´»å¯èƒ½ã€‚ -->
  <a href="./nearby_manholes.html" class="nav-link" style="margin-right: 8px;">ğŸ“ è¿‘ãã®ãƒãƒ³ãƒ›ãƒ¼ãƒ«</a>
  <a href="./gmanhole_map.html" class="nav-link" id="nav-link">ğŸ¤– ã‚¬ãƒ³ãƒ€ãƒ  & ãƒã‚±ãµãŸçµ±åˆ</a>
    </div>
    <div class="controls-content" role="region" aria-label="Filters and statistics">
      <div class="tab-buttons" role="tablist" aria-label="Filter type">
        <button class="tab-button active" role="tab" aria-selected="true" aria-controls="prefecture-tab" id="tab-prefecture" onclick="switchTab('prefecture')">ğŸ—¾ éƒ½é“åºœçœŒ</button>
        <button class="tab-button" role="tab" aria-selected="false" aria-controls="pokemon-tab" id="tab-pokemon" onclick="switchTab('pokemon')">ğŸ¯ ãƒã‚±ãƒ¢ãƒ³</button>
      </div>
      <!-- Added recent 1 month filter -->
      <div class="filter-section filter-panel" id="recent-filter-wrapper">
        <label style="cursor:pointer;">
          <input type="checkbox" id="recent-toggle" /> <span data-i18n="recentLabel">ğŸ†• ç›´è¿‘1ãƒ¶æœˆ</span>
        </label>
      </div>
      <div id="prefecture-tab" class="tab-content active" role="tabpanel" tabindex="0" aria-labelledby="tab-prefecture">
        <div id="selected-prefecture-badge" class="selected-prefecture-badge" style="display:none; margin:4px 0; font-size:0.85rem; background:#eef; padding:4px 8px; border-radius:6px;">
          <span class="badge-label" style="font-weight:600;">é¸æŠä¸­:</span> <span class="badge-value"></span>
          <button type="button" class="badge-clear" style="margin-left:6px; background:#ccc; border:none; padding:2px 6px; border-radius:4px; cursor:pointer;" aria-label="é¸æŠè§£é™¤" onclick="clearPrefectureSelection()">âœ–</button>
        </div>
        <div class="filter-section filter-panel" aria-labelledby="heading-pref-count">
          <h4 id="heading-pref-count">éƒ½é“åºœçœŒåˆ¥ãƒã‚±ãµãŸæ•°</h4>
          <label class="sr-only" for="search-input">éƒ½é“åºœçœŒæ¤œç´¢</label>
          <input type="text" class="search-input" id="search-input" placeholder="éƒ½é“åºœçœŒã‚’æ¤œç´¢..." aria-describedby="pref-table-desc">
          <table class="prefecture-table" id="prefecture-table" aria-describedby="pref-table-desc">
            <caption id="pref-table-desc" class="sr-only">éƒ½é“åºœçœŒã”ã¨ã®ãƒã‚±ãµãŸæ•°ã¨ã‚µã‚¤ãƒˆæœ‰ç„¡</caption>
            <thead>
              <tr>
                <th scope="col">ã‚³ãƒ¼ãƒ‰</th>
                <th scope="col">éƒ½é“åºœçœŒ</th>
                <th scope="col">ãƒã‚±ãµãŸæ•°</th>
                <th scope="col">ã‚µã‚¤ãƒˆ</th>
              </tr>
            </thead>
            <tbody id="prefecture-table-body"></tbody>
          </table>
          <div id="search-hit-counter" style="display:none; font-size:0.75rem; margin-top:4px; color:#555;"></div>
        </div>
      </div>
      <div id="pokemon-tab" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-pokemon" hidden>
        <div class="filter-section filter-panel">
          <h4 id="heading-pokemon-filter">ãƒã‚±ãƒ¢ãƒ³ã§çµã‚Šè¾¼ã¿</h4>
          <label class="sr-only" for="pokemon-search">ãƒã‚±ãƒ¢ãƒ³æ¤œç´¢</label>
          <input type="text" class="search-input" id="pokemon-search" placeholder="ãƒã‚±ãƒ¢ãƒ³ã‚’æ¤œç´¢...">
          <div id="pokemon-grid" class="pokemon-grid" role="list" aria-label="ãƒã‚±ãƒ¢ãƒ³ä¸€è¦§"></div>
        </div>
      </div>
      <button class="reset-btn" onclick="resetMap()" aria-live="polite">ğŸ”„ ã™ã¹ã¦è¡¨ç¤º</button>
      <div class="stats" role="status" aria-live="polite">
        <div id="total-count">ç·æ•°: <span>0</span></div>
        <div id="visible-count">è¡¨ç¤º: <span>0</span></div>
        <div id="city-count">å¸‚ç”ºæ‘: <span>0</span></div>
      </div>
    </div>
  </div>
  <div id="map"></div>
  <!-- ãƒãƒŠãƒ¼ã‚’åœ°å›³ä¸Šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨ã—ã¦é…ç½® -->
  <div id="sibling-site-banner" class="upload-banner" role="note" aria-label="å…„å¼Ÿã‚µã‚¤ãƒˆã¸ã®å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¡ˆå†…" aria-live="polite" hidden>
    <div class="upload-banner__inner">
      <strong class="upload-banner__title">ğŸ“· å†™çœŸå”åŠ›ã®ãŠé¡˜ã„</strong>
      <span class="upload-banner__body">ãƒãƒ³ãƒ›ãƒ¼ãƒ«å†™çœŸã‚’ãŠæŒã¡ãªã‚‰å…„å¼Ÿã‚µã‚¤ãƒˆ <a href="https://pokefuta.com/" target="_blank" rel="noopener" class="upload-banner__link">pokefuta.com</a> ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å…±æœ‰ã§ãã¾ã™ã€‚</span>
      <button type="button" aria-label="æ¡ˆå†…ã‚’é–‰ã˜ã‚‹" id="banner-close" class="upload-banner__close" title="é–‰ã˜ã‚‹">âœ•</button>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const pokefutaIcon = L.icon({
  iconUrl: './assets/pokefuta_icon_32.png',  // 32pxç‰ˆã‚’ä½¿ã†å ´åˆ
  iconSize: [32, 32],                 // ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚µã‚¤ã‚º
  iconAnchor: [16, 16],               // ä¸­å¿ƒã«åˆã‚ã›ã‚‹ï¼ˆ[æ¨ª/2, ç¸¦/2]ï¼‰
  popupAnchor: [0, -16]               // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä½ç½®è£œæ­£
});
    const map = L.map('map').setView([36.0, 138.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°
    const prefectureCodeMap = {
      'åŒ—æµ·é“': '01', 'é’æ£®çœŒ': '02', 'å²©æ‰‹çœŒ': '03', 'å®®åŸçœŒ': '04', 'ç§‹ç”°çœŒ': '05',
      'å±±å½¢çœŒ': '06', 'ç¦å³¶çœŒ': '07', 'èŒ¨åŸçœŒ': '08', 'æ ƒæœ¨çœŒ': '09', 'ç¾¤é¦¬çœŒ': '10',
      'åŸ¼ç‰çœŒ': '11', 'åƒè‘‰çœŒ': '12', 'æ±äº¬éƒ½': '13', 'ç¥å¥ˆå·çœŒ': '14', 'æ–°æ½ŸçœŒ': '15',
      'å¯Œå±±çœŒ': '16', 'çŸ³å·çœŒ': '17', 'ç¦äº•çœŒ': '18', 'å±±æ¢¨çœŒ': '19', 'é•·é‡çœŒ': '20',
      'å²é˜œçœŒ': '21', 'é™å²¡çœŒ': '22', 'æ„›çŸ¥çœŒ': '23', 'ä¸‰é‡çœŒ': '24', 'æ»‹è³€çœŒ': '25',
      'äº¬éƒ½åºœ': '26', 'å¤§é˜ªåºœ': '27', 'å…µåº«çœŒ': '28', 'å¥ˆè‰¯çœŒ': '29', 'å’Œæ­Œå±±çœŒ': '30',
      'é³¥å–çœŒ': '31', 'å³¶æ ¹çœŒ': '32', 'å²¡å±±çœŒ': '33', 'åºƒå³¶çœŒ': '34', 'å±±å£çœŒ': '35',
      'å¾³å³¶çœŒ': '36', 'é¦™å·çœŒ': '37', 'æ„›åª›çœŒ': '38', 'é«˜çŸ¥çœŒ': '39', 'ç¦å²¡çœŒ': '40',
      'ä½è³€çœŒ': '41', 'é•·å´çœŒ': '42', 'ç†Šæœ¬çœŒ': '43', 'å¤§åˆ†çœŒ': '44', 'å®®å´çœŒ': '45',
      'é¹¿å…å³¶çœŒ': '46', 'æ²–ç¸„çœŒ': '47'
    };

    // éƒ½é“åºœçœŒä¸­å¿ƒåº§æ¨™ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆã‚¯ãƒªãƒƒã‚¯æ™‚ã®ç§»å‹•ç”¨ï¼‰
    const prefectureCenterCoords = {
      'åŒ—æµ·é“': [43.064, 141.347], 'é’æ£®çœŒ': [40.824, 140.740], 'å²©æ‰‹çœŒ': [39.704, 141.153],
      'å®®åŸçœŒ': [38.269, 140.872], 'ç§‹ç”°çœŒ': [39.719, 140.103], 'å±±å½¢çœŒ': [38.240, 140.363],
      'ç¦å³¶çœŒ': [37.750, 140.468], 'èŒ¨åŸçœŒ': [36.342, 140.447], 'æ ƒæœ¨çœŒ': [36.566, 139.883],
      'ç¾¤é¦¬çœŒ': [36.391, 139.061], 'åŸ¼ç‰çœŒ': [35.857, 139.649], 'åƒè‘‰çœŒ': [35.605, 140.123],
      'æ±äº¬éƒ½': [35.690, 139.692], 'ç¥å¥ˆå·çœŒ': [35.448, 139.643], 'æ–°æ½ŸçœŒ': [37.902, 139.023],
      'å¯Œå±±çœŒ': [36.695, 137.211], 'çŸ³å·çœŒ': [36.595, 136.626], 'ç¦äº•çœŒ': [36.065, 136.222],
      'å±±æ¢¨çœŒ': [35.664, 138.568], 'é•·é‡çœŒ': [36.651, 138.181], 'å²é˜œçœŒ': [35.391, 136.722],
      'é™å²¡çœŒ': [34.977, 138.383], 'æ„›çŸ¥çœŒ': [35.180, 136.907], 'ä¸‰é‡çœŒ': [34.730, 136.509],
      'æ»‹è³€çœŒ': [35.004, 135.869], 'äº¬éƒ½åºœ': [35.021, 135.756], 'å¤§é˜ªåºœ': [34.686, 135.520],
      'å…µåº«çœŒ': [34.691, 135.183], 'å¥ˆè‰¯çœŒ': [34.685, 135.833], 'å’Œæ­Œå±±çœŒ': [34.226, 135.167],
      'é³¥å–çœŒ': [35.504, 134.238], 'å³¶æ ¹çœŒ': [35.472, 133.051], 'å²¡å±±çœŒ': [34.662, 133.935],
      'åºƒå³¶çœŒ': [34.396, 132.460], 'å±±å£çœŒ': [34.186, 131.471], 'å¾³å³¶çœŒ': [34.066, 134.559],
      'é¦™å·çœŒ': [34.340, 134.043], 'æ„›åª›çœŒ': [33.842, 132.766], 'é«˜çŸ¥çœŒ': [33.560, 133.531],
      'ç¦å²¡çœŒ': [33.607, 130.418], 'ä½è³€çœŒ': [33.250, 130.299], 'é•·å´çœŒ': [32.745, 129.874],
      'ç†Šæœ¬çœŒ': [32.790, 130.742], 'å¤§åˆ†çœŒ': [33.238, 131.613], 'å®®å´çœŒ': [31.911, 131.424],
      'é¹¿å…å³¶çœŒ': [31.560, 130.558], 'æ²–ç¸„çœŒ': [26.212, 127.679]
    };

    let allMarkers = [];
    let allData = [];
    let prefectureCounts = {};
    let prefectureSiteCounts = {};
    let cityCounts = {};
    let selectedPrefecture = '';
    let pokemonCounts = {};
    let selectedPokemons = [];
    let currentTab = 'prefecture';
    let filterRecent = false; // recent 30 days filter
    let hasAddedAtField = false; // whether dataset has any date field

    // ==== å˜ä¸€è¨€èª (æ—¥æœ¬èª) ç”¨ UI ãƒ©ãƒ™ãƒ«å®šæ•° ==== 
    const UI_TEXT = {
      recentLabel: 'ğŸ†• ç›´è¿‘1ãƒ¶æœˆ',
      prefectureFilter: 'éƒ½é“åºœçœŒã§çµã‚Šè¾¼ã¿',
      allPrefectures: 'ã™ã¹ã¦ã®éƒ½é“åºœçœŒ',
      prefectureCount: 'éƒ½é“åºœçœŒåˆ¥ãƒã‚±ãµãŸæ•°',
      searchPrefecture: 'éƒ½é“åºœçœŒã‚’æ¤œç´¢...',
      codeHeader: 'ã‚³ãƒ¼ãƒ‰',
      prefectureHeader: 'éƒ½é“åºœçœŒ',
      countHeader: 'ãƒã‚±ãµãŸæ•°',
      siteHeader: 'ã‚µã‚¤ãƒˆ',
      pokemonFilter: 'ãƒã‚±ãƒ¢ãƒ³ã§çµã‚Šè¾¼ã¿',
      searchPokemon: 'ãƒã‚±ãƒ¢ãƒ³ã‚’æ¤œç´¢...',
      showAll: 'ğŸ”„ ã™ã¹ã¦è¡¨ç¤º',
      totalCount: 'ç·æ•°:',
      visibleCount: 'è¡¨ç¤º:',
      cityCount: 'å¸‚ç”ºæ‘:',
      idLabel: 'ID:',
      titleLabel: 'ã‚¿ã‚¤ãƒˆãƒ«:',
      prefectureLabel: 'éƒ½é“åºœçœŒ:',
      pokemonLabel: 'ãƒã‚±ãƒ¢ãƒ³:',
      cityLabel: 'å¸‚ç”ºæ‘:',
      officialDetail: 'ğŸ“ å…¬å¼è©³ç´°',
      prefectureSite: 'ã‚µã‚¤ãƒˆ'
    };

    // åˆæœŸãƒ†ã‚­ã‚¹ãƒˆã¯æ—¢ã« HTML ã«è¨˜è¿°ã—ã¦ã„ã‚‹ãŸã‚ updateUIText ã¯ä¸è¦
    function updateUIText() { /* no-op (å¤šè¨€èªå‰Šé™¤) */ }

    async function loadPokefutaData() {
      try {
        // Try multiple potential paths for pokefuta data
        const pokefutaPaths = [
          './pokefuta.ndjson',  // Current relative path
          'pokefuta.ndjson',    // Direct filename
          '../pokefuta.ndjson', // Parent directory
          'https://raw.githubusercontent.com/nishiokya/pokefuta-tracker/main/docs/pokefuta.ndjson' // Fallback to GitHub raw
        ];
        
        let res = null;
        for (const path of pokefutaPaths) {
          try {
            console.log(`Trying to fetch pokefuta data from: ${path}`);
            res = await fetch(path);
            if (res.ok) {
              console.log(`Successfully loaded pokefuta data from: ${path}`);
              break;
            }
          } catch (e) {
            console.warn(`Failed to fetch from ${path}:`, e);
          }
        }
        
        if (!res || !res.ok) {
          throw new Error('Could not load pokefuta data from any path');
        }
        
        const text = await res.text();
        const lines = text.trim().split('\n');
        allData = [];
        // é›†ç´„: åŒä¸€ id ã®è¤‡æ•°ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
        //   ãƒ»added_at / first_seen ã¯æœ€å¤å€¤
        //   ãƒ»last_seen / source_last_checked / last_updated ã¯æœ€æ–°å€¤
        //   ãƒ»ãã®ä»–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æœ€æ–°ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒ™ãƒ¼ã‚¹
        const aggById = new Map();
        for (const line of lines) {
          if (!line.trim()) continue;
          let obj; try { obj = JSON.parse(line); } catch { continue; }
          const existing = aggById.get(obj.id);
          if (!existing) {
            aggById.set(obj.id, { ...obj });
          } else {
            function earlier(a,b){ if(!a) return b; if(!b) return a; return new Date(a) <= new Date(b) ? a : b; }
            function later(a,b){ if(!a) return b; if(!b) return a; return new Date(a) >= new Date(b) ? a : b; }
            // keep earliest for creation-ish fields
            existing.added_at = earlier(existing.added_at, obj.added_at);
            existing.first_seen = earlier(existing.first_seen, obj.first_seen);
            // keep latest for observation-ish fields
            existing.last_seen = later(existing.last_seen, obj.last_seen);
            existing.source_last_checked = later(existing.source_last_checked, obj.source_last_checked);
            existing.last_updated = later(existing.last_updated, obj.last_updated);
            // For other mutable fields (title, pokemons etc.) assume latest line is authoritative
            Object.assign(existing, obj, {
              added_at: existing.added_at,
              first_seen: existing.first_seen,
              last_seen: existing.last_seen,
              source_last_checked: existing.source_last_checked,
              last_updated: existing.last_updated
            });
          }
        }
        allData = [...aggById.values()];
  // Detect presence of date field for recent filter (include source_last_checked / last_seen)
  hasAddedAtField = allData.some(d => d.added_at || d.first_seen || d.last_seen || d.source_last_checked || d.last_updated || d.date);
        // æ—¥ä»˜æ–‡å­—åˆ—ã®æ­£è¦åŒ– (Safari äº’æ› / microseconds é™¤å» / +00:00 â†’ Z)
        function normalizeDateString(ds) {
          if (!ds) return null;
          let cleaned = ds.trim();
          // If fractional seconds are more than 3 digits, trim to milliseconds (Safari å¯¾å¿œ)
          cleaned = cleaned.replace(/(\.\d{3})\d+(?=(Z|[+\-]\d{2}:?\d{2})?$)/, '$1');
          // If any fractional seconds remain with more than 6 digits, drop entirely
          cleaned = cleaned.replace(/\.\d{4,6}(?=(Z|[+\-]\d{2}:?\d{2})?$)/, match => match.slice(0,4));
          // Convert +00:00 to Z for consistency
          cleaned = cleaned.replace(/\+00:00$/, 'Z');
          // If timezone missing but pattern looks like ISO, append Z
          if (!/(Z|[+\-]\d{2}:?\d{2})$/.test(cleaned) && /T\d{2}:\d{2}:\d{2}/.test(cleaned)) cleaned += 'Z';
          const t = Date.parse(cleaned);
          return isNaN(t) ? null : new Date(t);
        }
        // Pre-compute reference date for "recent" filter
        // å„ªå…ˆé †ä½: added_at > first_seen > last_seen > source_last_checked > last_updated > date
        allData.forEach(d => {
          const raw = d.added_at || d.first_seen || d.last_seen || d.source_last_checked || d.last_updated || d.date;
          d._addedDate = normalizeDateString(raw);
        });
        // Build markers
        allMarkers = [];
        prefectureCounts = {}; prefectureSiteCounts = {}; cityCounts = {}; pokemonCounts = {};
        allData.forEach(d => {
          const prefecture = d.prefecture || 'ä¸æ˜';
          const prefectureCode = prefectureCodeMap[prefecture] || '--';
          prefectureCounts[prefecture] = (prefectureCounts[prefecture] || 0) + 1;
          if (d.prefecture_site_url) {
            prefectureSiteCounts[prefecture] = (prefectureSiteCounts[prefecture] || 0) + 1;
          }
          if (d.city) cityCounts[d.city] = (cityCounts[d.city] || 0) + 1;
          if (Array.isArray(d.pokemons)) {
            d.pokemons.forEach(p => { if (p) pokemonCounts[p] = (pokemonCounts[p] || 0) + 1; });
          }
          const pokemonsStr = Array.isArray(d.pokemons) && d.pokemons.length ? d.pokemons.join(', ') : 'â€”';
          const cityInfo = d.city ? `<br/><b>${UI_TEXT.cityLabel}</b> ${d.city}` : '';
          const prefectureSiteLink = d.prefecture_site_url ? `<br/><a href='${d.prefecture_site_url}' target='_blank' class='popup-link popup-link--site'>ğŸŒ ${prefecture}${UI_TEXT.prefectureSite}</a>` : '';
          // ç”»åƒç„¡ã„å ´åˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¡ˆå†…ãƒªãƒ³ã‚¯ (ä»®: d.image_url ãŒç„¡ã„ã¨åˆ¤æ–­) â€»ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¿œã˜ã¦èª¿æ•´å¯èƒ½
          const uploadLink = !d.image_url ? `<br/><a href='https://pokefuta.com/' target='_blank' rel='noopener' class='popup-link popup-link--upload' title='å†™çœŸã‚’å…±æœ‰ (å…„å¼Ÿã‚µã‚¤ãƒˆ)'>ğŸ“· å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>` : '';
          const popupContent = `
            <div class='popup-box'>
              <b>${UI_TEXT.idLabel}</b> ${d.id}<br/>
              <b>${UI_TEXT.titleLabel}</b> <span class="popup-title">${d.title}</span><br/>
              <b>${UI_TEXT.prefectureLabel}</b> ${prefecture} <span class="prefecture-code">${prefectureCode}</span>${cityInfo}<br/>
              <b>${UI_TEXT.pokemonLabel}</b> <span class="popup-pokemons">${pokemonsStr}</span><br/>
              <a href='${d.detail_url}' target='_blank' class='popup-link'>${UI_TEXT.officialDetail}</a>${prefectureSiteLink}${uploadLink}
            </div>
          `;
          const marker = L.marker([d.lat, d.lng], { icon: pokefutaIcon }).bindPopup(popupContent);
          marker.pokefutaData = d; marker.pokefutaData.prefectureCode = prefectureCode;
          allMarkers.push(marker); marker.addTo(map);
        });
          // populatePrefectureFilter(); // Removed as per patch requirement
        populatePrefectureTable();
        populatePokemonGrid();
        updateStats();
        initRecentFilter();
        updateRecentSummary();
      } catch (e) {
        console.error('ãƒã‚±ãµãŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—', e);
      }
    }

    function initRecentFilter() {
      const toggle = document.getElementById('recent-toggle');
      if (!toggle) return;
      if (!hasAddedAtField) {
        toggle.disabled = true;
        toggle.title = 'ãƒ‡ãƒ¼ã‚¿ã«æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (added_at / first_seen / last_updated / date) ãŒç„¡ã„ãŸã‚åˆ©ç”¨ã§ãã¾ã›ã‚“';
      }
      toggle.addEventListener('change', e => {
        filterRecent = e.target.checked;
        recomputeVisibility();
        updateRecentSummary();
      });
    }

    function countRecent(days=30){
      const now = Date.now();
      const span = days*86400000;
      let c=0; allData.forEach(d=>{ if(d._addedDate){ const diff = now - d._addedDate.getTime(); if(diff>=0 && diff<=span) c++; }}); return c;
    }

    function ensureRecentSummaryElement(){
      let el = document.getElementById('recent-summary');
      if(!el){
        const wrapper = document.getElementById('recent-filter-wrapper');
        if(wrapper){
          el = document.createElement('div');
          el.id = 'recent-summary';
          el.style.fontSize='0.7rem';
          el.style.marginTop='2px';
          el.style.color='#555';
          wrapper.appendChild(el);
        }
      }
      return el;
    }

    function updateRecentSummary(){
      const el = ensureRecentSummaryElement();
      if(!el) return;
      if(!hasAddedAtField){ el.textContent='æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—'; return; }
      const recentCnt = countRecent(30);
      const total = allData.length;
      if(recentCnt===0){ el.textContent='ç›´è¿‘30æ—¥: 0ä»¶ (æ–°è¦ç„¡ã—)'; }
      else if(recentCnt===total){ el.textContent=`ç›´è¿‘30æ—¥: å…¨${total}ä»¶ (å…¨ã¦æ–°è¦ã¾ãŸã¯30æ—¥ä»¥å†…)`; }
      else { el.textContent=`ç›´è¿‘30æ—¥: ${recentCnt} / ${total}`; }
    }

    function isWithinLastDays(dateObj, days) {
      if (!dateObj) return false;
      const now = new Date();
      return (now - dateObj) <= days * 86400000 && (now - dateObj) >= 0;
    }

    function recomputeVisibility() {
      let visibleCount = 0;
      allMarkers.forEach(marker => {
        const d = marker.pokefutaData;
        let show = true;
        if (selectedPrefecture) show = show && d.prefecture === selectedPrefecture;
        if (selectedPokemons.length > 0) {
          const mp = d.pokefutaData ? d.pokefutaData.pokemons : (d.pokemons || []);
          const pList = d.pokemons || [];
          show = show && selectedPokemons.some(p => pList.includes(p));
        }
  if (filterRecent) show = show && isWithinLastDays(d._addedDate, 30);
        if (show) {
          if (!map.hasLayer(marker)) marker.addTo(map);
          visibleCount++;
        } else {
          if (map.hasLayer(marker)) map.removeLayer(marker);
        }
      });
      updateStats(visibleCount);
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚¯ãƒªãƒƒã‚¯çµã‚Šè¾¼ã¿ç”¨ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å»ƒæ­¢ï¼‰
    function filterByPrefectureFromTable(prefecture) {
      selectedPrefecture = prefecture || '';
      document.querySelectorAll('#prefecture-table-body tr').forEach(row => {
        const rowPref = row.children[1]?.textContent;
        const match = !selectedPrefecture || rowPref === selectedPrefecture;
        row.style.display = match ? '' : 'none';
        row.classList.toggle('selected', rowPref === selectedPrefecture && selectedPrefecture);
      });
      recomputeVisibility();
    }

    function showSelectedPrefectureBadge() {
      const badge = document.getElementById('selected-prefecture-badge');
      const val = badge?.querySelector('.badge-value');
      if (!badge || !val) return;
      if (selectedPrefecture) {
        val.textContent = selectedPrefecture;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
        val.textContent = '';
      }
    }

    function clearPrefectureSelection() {
      selectedPrefecture = '';
      filterByPrefectureFromTable('');
      showSelectedPrefectureBadge();
      searchPrefectures();
    }

    function togglePrefectureSelection(prefecture) {
      if (selectedPrefecture === prefecture) {
        clearPrefectureSelection();
      } else {
        filterByPrefectureFromTable(prefecture);
        showSelectedPrefectureBadge();
        searchPrefectures();
      }
    }

    function searchPrefectures() {
      const q = document.getElementById('search-input')?.value?.trim() || '';
      document.querySelectorAll('#prefecture-table-body tr').forEach(row => {
        const name = row.children[1]?.textContent || '';
        const match = !q || name.includes(q);
        const rowPref = row.children[1]?.textContent;
        const forceShow = selectedPrefecture && rowPref === selectedPrefecture;
        row.style.display = (match || forceShow) ? '' : 'none';
      });
      updateSearchHitCounter();
    }

    function updateSearchHitCounter() {
      const counter = document.getElementById('search-hit-counter');
      if (!counter) return;
      const q = document.getElementById('search-input')?.value?.trim();
      if (!q) {
        counter.style.display = 'none';
        counter.textContent = '';
        return;
      }
      let visible = 0;
      document.querySelectorAll('#prefecture-table-body tr').forEach(r => { if (r.style.display !== 'none') visible++; });
      counter.textContent = `æ¤œç´¢ãƒ’ãƒƒãƒˆ: ${visible} ä»¶`;
      counter.style.display = 'block';
    }

    // (æ—§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½å‰Šé™¤æ¸ˆã¿)
    // â†‘ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³é–¢é€£ã¯ä¸è¦ã«ãªã£ãŸãŸã‚å¾Œã§å‰Šé™¤äºˆå®š

    function updateStats(visibleOverride) {
      const totalEl = document.querySelector('#total-count span');
      const visibleEl = document.querySelector('#visible-count span');
      const cityEl = document.querySelector('#city-count span');
      if (totalEl) totalEl.textContent = String(allMarkers.length);
      if (visibleEl) {
        const visibleCount = typeof visibleOverride === 'number' ? visibleOverride : document.querySelectorAll('#map .leaflet-marker-pane img').length;
        visibleEl.textContent = String(visibleCount);
      }
      if (cityEl) cityEl.textContent = String(Object.keys(cityCounts).length);
    }

    function populatePrefectureTable() {
      const tbody = document.getElementById('prefecture-table-body');

      // Create array of all 47 prefectures with their counts
      const allPrefectures = Object.keys(prefectureCodeMap).map(prefecture => [
        prefecture,
        prefectureCounts[prefecture] || 0
      ]);

      // Sort by prefecture code
      allPrefectures.sort(([a], [b]) => {
        const codeA = prefectureCodeMap[a];
        const codeB = prefectureCodeMap[b];
        return codeA.localeCompare(codeB);
      });

      // Add ä¸æ˜ at the end if exists
      if (prefectureCounts['ä¸æ˜']) {
        allPrefectures.push(['ä¸æ˜', prefectureCounts['ä¸æ˜']]);
      }

      allPrefectures.forEach(([prefecture, count]) => {
        const row = document.createElement('tr');
        const code = prefectureCodeMap[prefecture] || '--';
        const siteCount = prefectureSiteCounts[prefecture] || 0;
        const siteIcon = siteCount > 0 ? 'ğŸŒ' : 'â€”';

        // Style row differently if no pokefuta
        const countBadgeClass = count > 0 ? 'count-badge' : 'count-badge-zero';
        const rowClass = count === 0 ? 'no-pokefuta' : '';

        row.className = rowClass;
        row.innerHTML = `
          <td><span class="prefecture-code">${code}</span></td>
          <td>${prefecture}</td>
          <td><span class="${countBadgeClass}">${count}</span></td>
          <td style="text-align: center;">${siteIcon}</td>
        `;
        if (count > 0) {
          // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ãƒªãƒƒã‚¯: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          row.addEventListener('click', () => filterByPrefectureFromTable(prefecture));
          // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯: åœ°å›³ç§»å‹•
          row.addEventListener('dblclick', () => zoomToPrefecture(prefecture));
          row.style.cursor = 'pointer';
          row.title = `ã‚¯ãƒªãƒƒã‚¯: ${prefecture}ã§ãƒ•ã‚£ãƒ«ã‚¿ / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯: åœ°å›³ç§»å‹•`;
        }
        // Append row (BUGFIX: previously not appended, table remained empty)
        tbody.appendChild(row);
      });
      const searchInput = document.getElementById('search-input');
      if (searchInput) searchInput.addEventListener('input', searchPrefectures);
    }
    // selectPrefectureFromTable removed (dropdownå»ƒæ­¢)

    // ãƒã‚±ãƒ¢ãƒ³ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ (æ—¥æœ¬èªã®ã¿)
    function populatePokemonGrid() {
      const grid = document.getElementById('pokemon-grid');
      if (!grid) return;
      const counts = {};
      allData.forEach(d => {
        if (Array.isArray(d.pokemons)) {
          d.pokemons.forEach(p => { if (p) counts[p] = (counts[p] || 0) + 1; });
        }
      });
      const sorted = Object.entries(counts)
        .sort(([a],[b]) => a.localeCompare(b,'ja'))
        .sort(([,ca],[,cb]) => cb - ca);
      grid.innerHTML = '';
      sorted.forEach(([name,count]) => {
        const item = document.createElement('div');
        item.className = 'pokemon-item';
        item.innerHTML = `<div class="pokemon-name">${name}</div><div class="pokemon-count">${count}</div>`;
        item.addEventListener('click', () => togglePokemonSelection(name, item));
        grid.appendChild(item);
      });
      const searchInput = document.getElementById('pokemon-search');
      if (searchInput) {
        searchInput.removeEventListener('input', searchPokemons);
        searchInput.addEventListener('input', searchPokemons);
      }
    }

    function togglePokemonSelection(pokemon, item) {
      const index = selectedPokemons.indexOf(pokemon);

      if (index > -1) {
        selectedPokemons.splice(index, 1);
        item.classList.remove('selected');
      } else {
        selectedPokemons.push(pokemon);
        item.classList.add('selected');
      }

      filterByPokemon();
    }

    function searchPokemons() {
      const query = document.getElementById('pokemon-search').value.toLowerCase();
      const items = document.querySelectorAll('#pokemon-grid .pokemon-item');

      items.forEach(item => {
        const pokemonName = item.querySelector('.pokemon-name').textContent.toLowerCase();
        const shouldShow = pokemonName.includes(query);
        item.style.display = shouldShow ? 'block' : 'none';
      });
    }

          // document.getElementById('prefecture-filter').value = prefecture; // Removed dropdown update

    function resetMap() {
      // Reset filters for both tabs
        // document.getElementById('prefecture-filter').value = ''; // Removed as per patch requirement
      document.getElementById('search-input').value = '';
      document.getElementById('pokemon-search').value = '';
    selectedPrefecture = '';
    filterByPrefectureFromTable('');
    showSelectedPrefectureBadge();
      filterRecent = false; const rt = document.getElementById('recent-toggle'); if (rt) rt.checked = false;

      // Show all markers
      allMarkers.forEach(marker => {
        if (!map.hasLayer(marker)) {
          marker.addTo(map);
        }
      });

      // Show all table rows
      document.querySelectorAll('#prefecture-table-body tr').forEach(row => {
        row.style.display = '';
        row.classList.remove('selected');
      });

      // Reset Pokemon selections
      document.querySelectorAll('#pokemon-grid .pokemon-item').forEach(item => {
        item.classList.remove('selected');
        item.style.display = 'block';
      });

      // Reset map view
      map.setView([36.0, 138.0], 6);
      updateStats();
      recomputeVisibility();
    }

    function switchTab(tabName) {
      currentTab = tabName;
      const tabs = ['prefecture','pokemon'];
      tabs.forEach(name => {
        const btn = document.getElementById(`tab-${name}`);
        const panel = document.getElementById(`${name}-tab`);
        const active = name === tabName;
        if (btn) {
          btn.classList.toggle('active', active);
          btn.setAttribute('aria-selected', active ? 'true':'false');
          btn.tabIndex = active ? 0 : -1;
        }
        if (panel) {
          panel.classList.toggle('active', active);
          if (active) {
            panel.removeAttribute('hidden');
            panel.setAttribute('aria-hidden','false');
          } else {
            panel.setAttribute('hidden','true');
            panel.setAttribute('aria-hidden','true');
          }
        }
      });
      if (tabName === 'prefecture') {
        selectedPokemons = [];
        document.querySelectorAll('#pokemon-grid .pokemon-item').forEach(item => item.classList.remove('selected'));
        const ps = document.getElementById('pokemon-search'); if (ps) ps.value='';
          filterByPrefectureFromTable(selectedPrefecture); // Updated to use new function
      } else if (tabName === 'pokemon') {
        selectedPrefecture = '';
          // const pf = document.getElementById('prefecture-filter'); if (pf) pf.value=''; // Removed as per patch requirement
        const si = document.getElementById('search-input'); if (si) si.value='';
        document.querySelectorAll('.prefecture-table tr').forEach(row => { row.classList.remove('selected'); row.style.display=''; });
        filterByPokemon();
      }
    }

    // å¤šè¨€èªæ©Ÿèƒ½å‰Šé™¤ã®ãŸã‚ switchLanguage / refreshMarkersContent ã¯ä¸è¦

    // Keyboard navigation for tabs (Left/Right/Home/End)
    document.addEventListener('keydown', (e) => {
      const activeEl = document.activeElement;
      if (activeEl && activeEl.getAttribute('role') === 'tab') {
        const order = ['prefecture','pokemon'];
        let idx = order.findIndex(t => `tab-${t}` === activeEl.id);
        if (e.key === 'ArrowRight') { e.preventDefault(); idx = (idx + 1) % order.length; document.getElementById(`tab-${order[idx]}`).focus(); switchTab(order[idx]); }
        else if (e.key === 'ArrowLeft') { e.preventDefault(); idx = (idx - 1 + order.length) % order.length; document.getElementById(`tab-${order[idx]}`).focus(); switchTab(order[idx]); }
        else if (e.key === 'Home') { e.preventDefault(); document.getElementById('tab-prefecture').focus(); switchTab('prefecture'); }
        else if (e.key === 'End') { e.preventDefault(); document.getElementById('tab-pokemon').focus(); switchTab('pokemon'); }
      }
    });

    // Leafletã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦éƒ½é“åºœçœŒã®ãƒã‚±ãµãŸã«ã‚ºãƒ¼ãƒ ã™ã‚‹é–¢æ•°
    function zoomToPrefecture(prefecture) {
      console.log(`Zooming to prefecture: ${prefecture}`);
      
      // æŒ‡å®šã•ã‚ŒãŸéƒ½é“åºœçœŒã®ãƒãƒ³ãƒ›ãƒ¼ãƒ«ãƒãƒ¼ã‚«ãƒ¼ã‚’å–å¾—
      const prefectureMarkers = allMarkers.filter(marker => {
        const data = marker.pokefutaData;
        return data && data.prefecture === prefecture;
      });

      if (prefectureMarkers.length === 0) {
        console.warn(`No manholes found for prefecture: ${prefecture}`);
        // ãƒãƒ³ãƒ›ãƒ¼ãƒ«ãŒãªã„å ´åˆã¯éƒ½é“åºœçœŒã®ä¸­å¿ƒåº§æ¨™ã«ã‚ºãƒ¼ãƒ 
        const center = prefectureCenterCoords[prefecture];
        if (center) {
          map.setView(center, 8);
        }
        return;
      }

      // Leafletã®FeatureGroupã‚’ä½¿ã£ã¦å¢ƒç•Œã‚’è¨ˆç®—
      const group = L.featureGroup(prefectureMarkers);
      
      try {
        if (prefectureMarkers.length === 1) {
          // 1ã¤ã®ãƒã‚±ãµãŸã®å ´åˆï¼šãã®ãƒã‚±ãµãŸã‚’ä¸­å¿ƒã«ã‚ºãƒ¼ãƒ 
          const marker = prefectureMarkers[0];
          const data = marker.pokefutaData;
          map.setView([data.lat, data.lng], 12);
        } else {
          // è¤‡æ•°ã®ãƒã‚±ãµãŸã®å ´åˆï¼šå…¨ã¦ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«fitBounds
          map.fitBounds(group.getBounds(), {
            padding: [20, 20],
            maxZoom: 14
          });
        }
        
        // éƒ½é“åºœçœŒãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚’ä¸€æ™‚çš„ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        highlightPrefectureRow(prefecture);
        
        console.log(`Successfully zoomed to ${prefecture} with ${prefectureMarkers.length} pokefuta`);
        
      } catch (error) {
        console.error(`Error zooming to ${prefecture}:`, error);
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯éƒ½é“åºœçœŒã®ä¸­å¿ƒåº§æ¨™ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const center = prefectureCenterCoords[prefecture];
        if (center) {
          map.setView(center, 8);
        }
      }
    }

    // éƒ½é“åºœçœŒãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹é–¢æ•°
    function highlightPrefectureRow(prefecture) {
      const rows = document.querySelectorAll('#prefecture-table-body tr');
      rows.forEach(row => {
        const rowText = row.textContent;
        if (rowText.includes(prefecture)) {
          const originalBg = row.style.backgroundColor;
          const originalBorder = row.style.border;
          
          // ãƒã‚¤ãƒ©ã‚¤ãƒˆåŠ¹æœ
          row.style.backgroundColor = '#e3f2fd';
          row.style.border = '2px solid #2196f3';
          row.style.boxShadow = '0 2px 8px rgba(33, 150, 243, 0.3)';
          
          // 2ç§’å¾Œã«å…ƒã«æˆ»ã™
          setTimeout(() => {
            row.style.backgroundColor = originalBg;
            row.style.border = originalBorder;
            row.style.boxShadow = '';
          }, 2000);
        }
      });
    }

    // Initialize
    loadPokefutaData();
    // Banner åˆæœŸåŒ–
    (function initSiblingBanner(){
      const banner = document.getElementById('sibling-site-banner');
      if(!banner) return;
      const closed = localStorage.getItem('pf_banner_closed');
      if(!closed) banner.hidden = false;
      const btn = document.getElementById('banner-close');
      if(btn){ btn.addEventListener('click',()=>{ banner.hidden = true; localStorage.setItem('pf_banner_closed','1'); }); }
    })();
  </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K18NR4GZG2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-K18NR4GZG2');
</script>