<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pok√©futa Mini Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #ffe66d 100%);
    }

    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: linear-gradient(180deg, #ffffff 0%, #f8fcff 100%);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(255, 107, 107, 0.3);
      max-width: 320px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 3px solid #ff6b6b;
    }

    .controls-header {
      padding: 18px 20px 14px 20px;
      border-bottom: 3px solid #ffe66d;
      background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
      border-radius: 13px 13px 0 0;
    }

    .controls-header h3 {
      margin: 0;
      font-size: 18px;
      color: white;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .controls-content {
      padding: 16px 20px;
      overflow-y: auto;
      flex: 1;
    }

    .tab-container {
      margin-bottom: 16px;
    }

    .tab-buttons {
      display: flex;
      border-bottom: 3px solid #ffe66d;
      margin-bottom: 16px;
      background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
    }

    .tab-button {
      flex: 1;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      color: #2c5282;
      transition: all 0.3s ease;
      border-bottom: 4px solid transparent;
    }

    .tab-button:hover {
      background: rgba(255, 230, 109, 0.4);
      color: #1a365d;
      transform: translateY(-2px);
    }

    .tab-button.active {
      background: linear-gradient(135deg, #ff6b6b, #ff8a8a);
      color: white;
      border-bottom-color: #ffe66d;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .filter-section {
      margin-bottom: 20px;
      background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
      padding: 16px;
      border-radius: 12px;
      border: 2px solid #4ecdc4;
      box-shadow: 0 4px 12px rgba(78, 205, 196, 0.1);
    }

    .filter-section h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: #2c5282;
      font-weight: 600;
    }

    .pokemon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      border: 2px solid #4ecdc4;
      border-radius: 12px;
      padding: 12px;
      background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
    }

    .pokemon-item {
      padding: 10px 12px;
      border: 2px solid #4ecdc4;
      border-radius: 10px;
      background: linear-gradient(135deg, #ffffff 0%, #f8fcff 100%);
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      user-select: none;
      color: #2c5282;
    }

    .pokemon-item:hover {
      background: linear-gradient(135deg, #ffe66d, #fff2a6);
      border-color: #ff6b6b;
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 16px rgba(255, 107, 107, 0.2);
    }

    .pokemon-item.selected {
      background: linear-gradient(135deg, #ff6b6b, #ff8a8a);
      color: white;
      border-color: #ffe66d;
      box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
    }

    .pokemon-count {
      color: #4ecdc4;
      font-size: 10px;
      margin-top: 4px;
      background: linear-gradient(135deg, #ffe66d, #fff2a6);
      padding: 2px 6px;
      border-radius: 8px;
      display: inline-block;
      border: 1px solid #4ecdc4;
    }

    .pokemon-item.selected .pokemon-count {
      color: #2c5282;
      background: linear-gradient(135deg, #ffe66d, #fff2a6);
      border-color: #ffe66d;
    }

    #prefecture-filter {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #4ecdc4;
      border-radius: 8px;
      font-size: 14px;
      background: linear-gradient(180deg, #ffffff 0%, #f0f8ff 100%);
      color: #2c5282;
      font-weight: 500;
    }

    #prefecture-filter:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
    }

    .prefecture-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(78, 205, 196, 0.1);
    }

    .prefecture-table th,
    .prefecture-table td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #e0f2f1;
    }

    .prefecture-table th {
      background: linear-gradient(135deg, #4ecdc4, #26a69a);
      font-weight: 600;
      color: white;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .prefecture-table tr:hover {
      background: linear-gradient(135deg, #ffe66d, #fff2a6);
      cursor: pointer;
    }

    .prefecture-table tr.selected {
      background: linear-gradient(135deg, #ff6b6b, #ff8a8a);
      color: white;
    }

    .prefecture-code {
      font-family: 'Monaco', 'Menlo', monospace;
      background: linear-gradient(135deg, #4ecdc4, #26a69a);
      color: white;
      padding: 3px 7px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: bold;
    }

    .count-badge {
      background: linear-gradient(135deg, #ff6b6b, #ff8a8a);
      color: white;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: bold;
      min-width: 20px;
      text-align: center;
      display: inline-block;
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
    }

    .count-badge-zero {
      background: linear-gradient(135deg, #e0e0e0, #cccccc);
      color: #666;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: bold;
      min-width: 20px;
      text-align: center;
      display: inline-block;
    }

    .prefecture-table tr.no-pokefuta {
      opacity: 0.6;
      cursor: default !important;
    }

    .prefecture-table tr.no-pokefuta:hover {
      background: transparent !important;
    }

    .stats {
      font-size: 12px;
      color: #666;
      border-top: 1px solid #eee;
      padding-top: 12px;
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
    }

    .reset-btn {
      background: linear-gradient(135deg, #ff6b6b, #ff8a8a);
      color: white;
      border: 2px solid #ffe66d;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      width: 100%;
      margin-top: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }

    .reset-btn:hover {
      background: linear-gradient(135deg, #4ecdc4, #26a69a);
      border-color: #ffe66d;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
    }

    .search-input {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #4ecdc4;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 10px;
      background: linear-gradient(180deg, #ffffff 0%, #f0f8ff 100%);
      color: #2c5282;
      font-weight: 500;
    }

    .search-input:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
    }

    #map { height: 100%; }
    .leaflet-popup-content-wrapper { border-radius: 12px; }

    @media (max-width: 768px) {
      #controls {
        position: fixed;
        top: auto;
        bottom: 0;
        right: 0;
        left: 0;
        max-width: none;
        max-height: 50vh;
        border-radius: 12px 12px 0 0;
      }
      #map {
        height: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="controls">
    <div class="controls-header">
      <h3>üóæ „Éù„Ç±„Åµ„Åü„Éû„ÉÉ„Éó</h3>
    </div>
    <div class="controls-content">
      <!-- Tab Interface -->
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('prefecture')">üóæ ÈÉΩÈÅìÂ∫úÁúå</button>
        <button class="tab-button" onclick="switchTab('pokemon')">üéØ „Éù„Ç±„É¢„É≥</button>
      </div>

      <!-- Prefecture Filter Tab -->
      <div id="prefecture-tab" class="tab-content active">
        <div class="filter-section">
          <h4>ÈÉΩÈÅìÂ∫úÁúå„ÅßÁµû„ÇäËæº„Åø</h4>
          <select id="prefecture-filter">
            <option value="">„Åô„Åπ„Å¶„ÅÆÈÉΩÈÅìÂ∫úÁúå</option>
          </select>
        </div>

        <div class="filter-section">
          <h4>ÈÉΩÈÅìÂ∫úÁúåÂà•„Éù„Ç±„Åµ„ÅüÊï∞</h4>
          <input type="text" class="search-input" id="search-input" placeholder="ÈÉΩÈÅìÂ∫úÁúå„ÇíÊ§úÁ¥¢...">
          <table class="prefecture-table" id="prefecture-table">
            <thead>
              <tr>
                <th>„Ç≥„Éº„Éâ</th>
                <th>ÈÉΩÈÅìÂ∫úÁúå</th>
                <th>„Éù„Ç±„Åµ„ÅüÊï∞</th>
                <th>„Çµ„Ç§„Éà</th>
              </tr>
            </thead>
            <tbody id="prefecture-table-body">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pokemon Filter Tab -->
      <div id="pokemon-tab" class="tab-content">
        <div class="filter-section">
          <h4>„Éù„Ç±„É¢„É≥„ÅßÁµû„ÇäËæº„Åø</h4>
          <input type="text" class="search-input" id="pokemon-search" placeholder="„Éù„Ç±„É¢„É≥„ÇíÊ§úÁ¥¢...">
          <div id="pokemon-grid" class="pokemon-grid">
            <!-- Pokemon items will be populated here -->
          </div>
        </div>
      </div>

      <button class="reset-btn" onclick="resetMap()">üîÑ „Åô„Åπ„Å¶Ë°®Á§∫</button>

      <div class="stats">
        <div id="total-count">Á∑èÊï∞: <span>0</span></div>
        <div id="visible-count">Ë°®Á§∫: <span>0</span></div>
        <div id="city-count">Â∏ÇÁî∫Êùë: <span>0</span></div>
      </div>
    </div>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([36.0, 138.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ÈÉΩÈÅìÂ∫úÁúå„Ç≥„Éº„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞
    const prefectureCodeMap = {
      'ÂåóÊµ∑ÈÅì': '01', 'ÈùíÊ£ÆÁúå': '02', 'Â≤©ÊâãÁúå': '03', 'ÂÆÆÂüéÁúå': '04', 'ÁßãÁî∞Áúå': '05',
      'Â±±ÂΩ¢Áúå': '06', 'Á¶èÂ≥∂Áúå': '07', 'Ëå®ÂüéÁúå': '08', 'Ê†ÉÊú®Áúå': '09', 'Áæ§È¶¨Áúå': '10',
      'ÂüºÁéâÁúå': '11', 'ÂçÉËëâÁúå': '12', 'Êù±‰∫¨ÈÉΩ': '13', 'Á•ûÂ•àÂ∑ùÁúå': '14', 'Êñ∞ÊΩüÁúå': '15',
      'ÂØåÂ±±Áúå': '16', 'Áü≥Â∑ùÁúå': '17', 'Á¶è‰∫ïÁúå': '18', 'Â±±Ê¢®Áúå': '19', 'Èï∑ÈáéÁúå': '20',
      'Â≤êÈòúÁúå': '21', 'ÈùôÂ≤°Áúå': '22', 'ÊÑõÁü•Áúå': '23', '‰∏âÈáçÁúå': '24', 'ÊªãË≥ÄÁúå': '25',
      '‰∫¨ÈÉΩÂ∫ú': '26', 'Â§ßÈò™Â∫ú': '27', 'ÂÖµÂ∫´Áúå': '28', 'Â•àËâØÁúå': '29', 'ÂíåÊ≠åÂ±±Áúå': '30',
      'È≥•ÂèñÁúå': '31', 'Â≥∂Ê†πÁúå': '32', 'Â≤°Â±±Áúå': '33', 'Â∫ÉÂ≥∂Áúå': '34', 'Â±±Âè£Áúå': '35',
      'Âæ≥Â≥∂Áúå': '36', 'È¶ôÂ∑ùÁúå': '37', 'ÊÑõÂ™õÁúå': '38', 'È´òÁü•Áúå': '39', 'Á¶èÂ≤°Áúå': '40',
      '‰ΩêË≥ÄÁúå': '41', 'Èï∑Â¥éÁúå': '42', 'ÁÜäÊú¨Áúå': '43', 'Â§ßÂàÜÁúå': '44', 'ÂÆÆÂ¥éÁúå': '45',
      'ÈπøÂÖêÂ≥∂Áúå': '46', 'Ê≤ñÁ∏ÑÁúå': '47'
    };

    let allMarkers = [];
    let allData = [];
    let prefectureCounts = {};
    let prefectureSiteCounts = {};
    let cityCounts = {};
    let selectedPrefecture = '';
    let pokemonCounts = {};
    let selectedPokemons = [];
    let currentTab = 'prefecture';

    async function loadPokefutaData() {
      try {
        const response = await fetch('./pokefuta.ndjson');
        const text = await response.text();
        const lines = text.trim().split('\n');

        lines.forEach(line => {
          if (line.trim()) {
            const data = JSON.parse(line);
            allData.push(data);

            // Count by prefecture
            const prefecture = data.prefecture || '‰∏çÊòé';
            prefectureCounts[prefecture] = (prefectureCounts[prefecture] || 0) + 1;

            // Count prefecture sites
            if (data.prefecture_site_url) {
              prefectureSiteCounts[prefecture] = (prefectureSiteCounts[prefecture] || 0) + 1;
            }

            // Count cities
            if (data.city) {
              const cityKey = `${prefecture}/${data.city}`;
              cityCounts[cityKey] = (cityCounts[cityKey] || 0) + 1;
            }

            // Count Pokemon
            if (data.pokemons && Array.isArray(data.pokemons)) {
              data.pokemons.forEach(pokemon => {
                if (pokemon && pokemon.trim()) {
                  pokemonCounts[pokemon] = (pokemonCounts[pokemon] || 0) + 1;
                }
              });
            }

            const pokemons = data.pokemons && data.pokemons.length > 0
              ? data.pokemons.join(', ')
              : '‚Äî';

            const prefectureCode = prefectureCodeMap[prefecture] || '--';

            const prefectureSiteLink = data.prefecture_site_url
              ? `<br/><a href='${data.prefecture_site_url}' target='_blank' style='color: #28a745; text-decoration: none;'>üåê ${prefecture}„Çµ„Ç§„Éà</a>`
              : '';

            const cityInfo = data.city ? `<br/><b>Â∏ÇÁî∫Êùë:</b> ${data.city}` : '';

            const popupContent = `
              <div style='min-width:200px'>
                <b>ID:</b> ${data.id}<br/>
                <b>„Çø„Ç§„Éà„É´:</b> ${data.title}<br/>
                <b>ÈÉΩÈÅìÂ∫úÁúå:</b> ${prefecture} <span class="prefecture-code">${prefectureCode}</span>${cityInfo}<br/>
                <b>„Éù„Ç±„É¢„É≥:</b> ${pokemons}<br/>
                <a href='${data.detail_url}' target='_blank' style='color: #007cba; text-decoration: none;'>üìù ÂÖ¨ÂºèË©≥Á¥∞</a>${prefectureSiteLink}
              </div>
            `;

            const marker = L.marker([data.lat, data.lng])
              .bindPopup(popupContent);

            marker.pokefutaData = data;
            marker.pokefutaData.prefectureCode = prefectureCode;
            allMarkers.push(marker);
            marker.addTo(map);
          }
        });

        populatePrefectureFilter();
        populatePrefectureTable();
        populatePokemonGrid();
        updateStats();
      } catch (error) {
        console.error('Error loading pokefuta data:', error);
      }
    }

    function populatePrefectureFilter() {
      const select = document.getElementById('prefecture-filter');

      // Get all 47 prefectures and sort by code
      const allPrefectures = Object.keys(prefectureCodeMap)
        .sort((a, b) => {
          const codeA = prefectureCodeMap[a];
          const codeB = prefectureCodeMap[b];
          return codeA.localeCompare(codeB);
        });

      // Add ‰∏çÊòé at the end if exists
      if (prefectureCounts['‰∏çÊòé']) {
        allPrefectures.push('‰∏çÊòé');
      }

      allPrefectures.forEach(prefecture => {
        const option = document.createElement('option');
        option.value = prefecture;
        const code = prefectureCodeMap[prefecture] || '--';
        const count = prefectureCounts[prefecture] || 0;
        option.textContent = `${code} ${prefecture} (${count})`;

        // Disable option if no pokefuta (but still show it)
        if (count === 0 && prefecture !== '‰∏çÊòé') {
          option.disabled = true;
          option.style.color = '#999';
        }

        select.appendChild(option);
      });

      select.addEventListener('change', filterByPrefecture);
    }

    function populatePrefectureTable() {
      const tbody = document.getElementById('prefecture-table-body');

      // Create array of all 47 prefectures with their counts
      const allPrefectures = Object.keys(prefectureCodeMap).map(prefecture => [
        prefecture,
        prefectureCounts[prefecture] || 0
      ]);

      // Sort by prefecture code
      allPrefectures.sort(([a], [b]) => {
        const codeA = prefectureCodeMap[a];
        const codeB = prefectureCodeMap[b];
        return codeA.localeCompare(codeB);
      });

      // Add ‰∏çÊòé at the end if exists
      if (prefectureCounts['‰∏çÊòé']) {
        allPrefectures.push(['‰∏çÊòé', prefectureCounts['‰∏çÊòé']]);
      }

      allPrefectures.forEach(([prefecture, count]) => {
        const row = document.createElement('tr');
        const code = prefectureCodeMap[prefecture] || '--';
        const siteCount = prefectureSiteCounts[prefecture] || 0;
        const siteIcon = siteCount > 0 ? 'üåê' : '‚Äî';

        // Style row differently if no pokefuta
        const countBadgeClass = count > 0 ? 'count-badge' : 'count-badge-zero';
        const rowClass = count === 0 ? 'no-pokefuta' : '';

        row.className = rowClass;
        row.innerHTML = `
          <td><span class="prefecture-code">${code}</span></td>
          <td>${prefecture}</td>
          <td><span class="${countBadgeClass}">${count}</span></td>
          <td style="text-align: center;">${siteIcon}</td>
        `;

        // Only add click handler if there are pokefuta
        if (count > 0) {
          row.addEventListener('click', () => {
            selectPrefectureFromTable(prefecture, row);
          });
          row.style.cursor = 'pointer';
        }

        tbody.appendChild(row);
      });

      // Add search functionality
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', searchPrefectures);
    }

    function selectPrefectureFromTable(prefecture, row) {
      // Update dropdown
      document.getElementById('prefecture-filter').value = prefecture;

      // Update table selection
      document.querySelectorAll('.prefecture-table tr').forEach(r => r.classList.remove('selected'));
      row.classList.add('selected');

      // Filter map
      selectedPrefecture = prefecture;
      filterByPrefecture();
    }

    function filterByPrefecture() {
      const selectedPref = document.getElementById('prefecture-filter').value || selectedPrefecture;
      let visibleCount = 0;

      allMarkers.forEach(marker => {
        const shouldShow = !selectedPref || marker.pokefutaData.prefecture === selectedPref;

        if (shouldShow) {
          if (!map.hasLayer(marker)) {
            marker.addTo(map);
          }
          visibleCount++;
        } else {
          if (map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
        }
      });

      updateStats(visibleCount);

      // Highlight table row
      updateTableSelection(selectedPref);

      // Adjust map view
      if (selectedPref) {
        fitMapToPrefecture(selectedPref);
      }
    }

    function updateTableSelection(prefecture) {
      document.querySelectorAll('.prefecture-table tr').forEach(row => {
        row.classList.remove('selected');
        const prefCell = row.cells[1];
        if (prefCell && prefCell.textContent === prefecture) {
          row.classList.add('selected');
        }
      });
    }

    function searchPrefectures() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const rows = document.querySelectorAll('#prefecture-table-body tr');

      rows.forEach(row => {
        const prefecture = row.cells[1].textContent.toLowerCase();
        const code = row.cells[0].textContent.toLowerCase();
        const shouldShow = prefecture.includes(query) || code.includes(query);
        row.style.display = shouldShow ? '' : 'none';
      });
    }

    function fitMapToPrefecture(prefecture) {
      const prefectureMarkers = allMarkers.filter(marker =>
        marker.pokefutaData.prefecture === prefecture
      );

      if (prefectureMarkers.length > 0) {
        const group = new L.featureGroup(prefectureMarkers);
        map.fitBounds(group.getBounds(), { padding: [20, 20] });
      }
    }

    function updateStats(visibleCount = null) {
      const totalElement = document.querySelector('#total-count span');
      const visibleElement = document.querySelector('#visible-count span');
      const cityElement = document.querySelector('#city-count span');

      totalElement.textContent = allMarkers.length;
      visibleElement.textContent = visibleCount !== null ? visibleCount : allMarkers.length;
      cityElement.textContent = Object.keys(cityCounts).length;
    }

    function populatePokemonGrid() {
      const grid = document.getElementById('pokemon-grid');
      const sortedPokemons = Object.entries(pokemonCounts)
        .sort(([a], [b]) => a.localeCompare(b, 'ja'))
        .sort(([, countA], [, countB]) => countB - countA);

      grid.innerHTML = '';

      sortedPokemons.forEach(([pokemon, count]) => {
        const item = document.createElement('div');
        item.className = 'pokemon-item';
        item.innerHTML = `
          <div class="pokemon-name">${pokemon}</div>
          <div class="pokemon-count">${count}</div>
        `;

        item.addEventListener('click', () => {
          togglePokemonSelection(pokemon, item);
        });

        grid.appendChild(item);
      });

      // Add search functionality for Pokemon
      const searchInput = document.getElementById('pokemon-search');
      searchInput.addEventListener('input', searchPokemons);
    }

    function togglePokemonSelection(pokemon, item) {
      const index = selectedPokemons.indexOf(pokemon);

      if (index > -1) {
        selectedPokemons.splice(index, 1);
        item.classList.remove('selected');
      } else {
        selectedPokemons.push(pokemon);
        item.classList.add('selected');
      }

      filterByPokemon();
    }

    function searchPokemons() {
      const query = document.getElementById('pokemon-search').value.toLowerCase();
      const items = document.querySelectorAll('#pokemon-grid .pokemon-item');

      items.forEach(item => {
        const pokemonName = item.querySelector('.pokemon-name').textContent.toLowerCase();
        const shouldShow = pokemonName.includes(query);
        item.style.display = shouldShow ? 'block' : 'none';
      });
    }

    function filterByPokemon() {
      if (selectedPokemons.length === 0) {
        // Show all markers if no Pokemon selected
        allMarkers.forEach(marker => {
          if (!map.hasLayer(marker)) {
            marker.addTo(map);
          }
        });
        updateStats();
        return;
      }

      let visibleCount = 0;

      allMarkers.forEach(marker => {
        const markerPokemons = marker.pokefutaData.pokemons || [];
        const shouldShow = selectedPokemons.some(selectedPokemon =>
          markerPokemons.includes(selectedPokemon)
        );

        if (shouldShow) {
          if (!map.hasLayer(marker)) {
            marker.addTo(map);
          }
          visibleCount++;
        } else {
          if (map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
        }
      });

      updateStats(visibleCount);
    }

    function switchTab(tabName) {
      currentTab = tabName;

      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`).classList.add('active');

      // Reset current filters when switching tabs
      if (tabName === 'prefecture') {
        // Reset Pokemon selections
        selectedPokemons = [];
        document.querySelectorAll('#pokemon-grid .pokemon-item').forEach(item => {
          item.classList.remove('selected');
        });
        document.getElementById('pokemon-search').value = '';

        // Apply prefecture filter if any
        filterByPrefecture();
      } else if (tabName === 'pokemon') {
        // Reset prefecture selections
        selectedPrefecture = '';
        document.getElementById('prefecture-filter').value = '';
        document.getElementById('search-input').value = '';
        document.querySelectorAll('.prefecture-table tr').forEach(row => {
          row.classList.remove('selected');
          row.style.display = '';
        });

        // Apply Pokemon filter if any
        filterByPokemon();
      }
    }

    function resetMap() {
      // Reset filters for both tabs
      document.getElementById('prefecture-filter').value = '';
      document.getElementById('search-input').value = '';
      document.getElementById('pokemon-search').value = '';
      selectedPrefecture = '';
      selectedPokemons = [];

      // Show all markers
      allMarkers.forEach(marker => {
        if (!map.hasLayer(marker)) {
          marker.addTo(map);
        }
      });

      // Show all table rows
      document.querySelectorAll('#prefecture-table-body tr').forEach(row => {
        row.style.display = '';
        row.classList.remove('selected');
      });

      // Reset Pokemon selections
      document.querySelectorAll('#pokemon-grid .pokemon-item').forEach(item => {
        item.classList.remove('selected');
        item.style.display = 'block';
      });

      // Reset map view
      map.setView([36.0, 138.0], 6);
      updateStats();
    }

    // Initialize
    loadPokefutaData();
  </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LX58JGRPNV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LX58JGRPNV');
</script>