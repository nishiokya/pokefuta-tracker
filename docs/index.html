<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PokÃ©futa Mini Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="./assets/theme.css" />
  <link rel="stylesheet" href="./assets/map.css" />
</head>
<body>
  <div id="controls" role="complementary" aria-labelledby="page-title">
    <div class="controls-header">
  <h3 id="page-title"><img src="./dataset/manhole_icon.png" width="30" alt="icon">ãƒã‚±ãµãŸãƒãƒƒãƒ—</h3>
      <div class="language-selector" role="group" aria-label="Language selector">
        <button class="lang-btn active" onclick="switchLanguage('ja')" data-lang="ja" aria-pressed="true">ğŸ‡¯ğŸ‡µ<span class="sr-only">æ—¥æœ¬èª</span></button>
        <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en" aria-pressed="false">ğŸ‡ºğŸ‡¸<span class="sr-only">English</span></button>
        <button class="lang-btn" onclick="switchLanguage('zh')" data-lang="zh" aria-pressed="false">ï¿½ï¿½<span class="sr-only">ä¸­æ–‡</span></button>
      </div>
      <a href="/pokefuta-tracker/nearby.html" class="nav-link" id="nav-link">ğŸ“ è¿‘ãã®ãƒãƒ³ãƒ›ãƒ¼ãƒ«</a>
    </div>
    <div class="controls-content" role="region" aria-label="Filters and statistics">
      <div class="tab-buttons" role="tablist" aria-label="Filter type">
        <button class="tab-button active" role="tab" aria-selected="true" aria-controls="prefecture-tab" id="tab-prefecture" onclick="switchTab('prefecture')">ğŸ—¾ éƒ½é“åºœçœŒ</button>
        <button class="tab-button" role="tab" aria-selected="false" aria-controls="pokemon-tab" id="tab-pokemon" onclick="switchTab('pokemon')">ğŸ¯ ãƒã‚±ãƒ¢ãƒ³</button>
      </div>
      <div id="prefecture-tab" class="tab-content active" role="tabpanel" tabindex="0" aria-labelledby="tab-prefecture">
        <div class="filter-section filter-panel">
          <h4 id="heading-pref-filter">éƒ½é“åºœçœŒã§çµã‚Šè¾¼ã¿</h4>
          <label class="sr-only" for="prefecture-filter">éƒ½é“åºœçœŒã‚»ãƒ¬ã‚¯ãƒˆ</label>
          <select id="prefecture-filter" aria-labelledby="heading-pref-filter">
            <option value="">ã™ã¹ã¦ã®éƒ½é“åºœçœŒ</option>
          </select>
        </div>
        <div class="filter-section filter-panel" aria-labelledby="heading-pref-count">
          <h4 id="heading-pref-count">éƒ½é“åºœçœŒåˆ¥ãƒã‚±ãµãŸæ•°</h4>
          <label class="sr-only" for="search-input">éƒ½é“åºœçœŒæ¤œç´¢</label>
          <input type="text" class="search-input" id="search-input" placeholder="éƒ½é“åºœçœŒã‚’æ¤œç´¢..." aria-describedby="pref-table-desc">
          <table class="prefecture-table" id="prefecture-table" aria-describedby="pref-table-desc">
            <caption id="pref-table-desc" class="sr-only">éƒ½é“åºœçœŒã”ã¨ã®ãƒã‚±ãµãŸæ•°ã¨ã‚µã‚¤ãƒˆæœ‰ç„¡</caption>
            <thead>
              <tr>
                <th scope="col">ã‚³ãƒ¼ãƒ‰</th>
                <th scope="col">éƒ½é“åºœçœŒ</th>
                <th scope="col">ãƒã‚±ãµãŸæ•°</th>
                <th scope="col">ã‚µã‚¤ãƒˆ</th>
              </tr>
            </thead>
            <tbody id="prefecture-table-body"></tbody>
          </table>
        </div>
      </div>
      <div id="pokemon-tab" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-pokemon" hidden>
        <div class="filter-section filter-panel">
          <h4 id="heading-pokemon-filter">ãƒã‚±ãƒ¢ãƒ³ã§çµã‚Šè¾¼ã¿</h4>
          <label class="sr-only" for="pokemon-search">ãƒã‚±ãƒ¢ãƒ³æ¤œç´¢</label>
          <input type="text" class="search-input" id="pokemon-search" placeholder="ãƒã‚±ãƒ¢ãƒ³ã‚’æ¤œç´¢...">
          <div id="pokemon-grid" class="pokemon-grid" role="list" aria-label="ãƒã‚±ãƒ¢ãƒ³ä¸€è¦§"></div>
        </div>
      </div>
      <button class="reset-btn" onclick="resetMap()" aria-live="polite">ğŸ”„ ã™ã¹ã¦è¡¨ç¤º</button>
      <div class="stats" role="status" aria-live="polite">
        <div id="total-count">ç·æ•°: <span>0</span></div>
        <div id="visible-count">è¡¨ç¤º: <span>0</span></div>
        <div id="city-count">å¸‚ç”ºæ‘: <span>0</span></div>
      </div>
    </div>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const pokefutaIcon = L.icon({
  iconUrl: './pokefuta_icon_32.png',  // 32pxç‰ˆã‚’ä½¿ã†å ´åˆ
  iconSize: [32, 32],                 // ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚µã‚¤ã‚º
  iconAnchor: [16, 16],               // ä¸­å¿ƒã«åˆã‚ã›ã‚‹ï¼ˆ[æ¨ª/2, ç¸¦/2]ï¼‰
  popupAnchor: [0, -16]               // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä½ç½®è£œæ­£
});
    const map = L.map('map').setView([36.0, 138.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°
    const prefectureCodeMap = {
      'åŒ—æµ·é“': '01', 'é’æ£®çœŒ': '02', 'å²©æ‰‹çœŒ': '03', 'å®®åŸçœŒ': '04', 'ç§‹ç”°çœŒ': '05',
      'å±±å½¢çœŒ': '06', 'ç¦å³¶çœŒ': '07', 'èŒ¨åŸçœŒ': '08', 'æ ƒæœ¨çœŒ': '09', 'ç¾¤é¦¬çœŒ': '10',
      'åŸ¼ç‰çœŒ': '11', 'åƒè‘‰çœŒ': '12', 'æ±äº¬éƒ½': '13', 'ç¥å¥ˆå·çœŒ': '14', 'æ–°æ½ŸçœŒ': '15',
      'å¯Œå±±çœŒ': '16', 'çŸ³å·çœŒ': '17', 'ç¦äº•çœŒ': '18', 'å±±æ¢¨çœŒ': '19', 'é•·é‡çœŒ': '20',
      'å²é˜œçœŒ': '21', 'é™å²¡çœŒ': '22', 'æ„›çŸ¥çœŒ': '23', 'ä¸‰é‡çœŒ': '24', 'æ»‹è³€çœŒ': '25',
      'äº¬éƒ½åºœ': '26', 'å¤§é˜ªåºœ': '27', 'å…µåº«çœŒ': '28', 'å¥ˆè‰¯çœŒ': '29', 'å’Œæ­Œå±±çœŒ': '30',
      'é³¥å–çœŒ': '31', 'å³¶æ ¹çœŒ': '32', 'å²¡å±±çœŒ': '33', 'åºƒå³¶çœŒ': '34', 'å±±å£çœŒ': '35',
      'å¾³å³¶çœŒ': '36', 'é¦™å·çœŒ': '37', 'æ„›åª›çœŒ': '38', 'é«˜çŸ¥çœŒ': '39', 'ç¦å²¡çœŒ': '40',
      'ä½è³€çœŒ': '41', 'é•·å´çœŒ': '42', 'ç†Šæœ¬çœŒ': '43', 'å¤§åˆ†çœŒ': '44', 'å®®å´çœŒ': '45',
      'é¹¿å…å³¶çœŒ': '46', 'æ²–ç¸„çœŒ': '47'
    };

    let allMarkers = [];
    let allData = [];
    let prefectureCounts = {};
    let prefectureSiteCounts = {};
    let cityCounts = {};
    let selectedPrefecture = '';
    let pokemonCounts = {};
    let selectedPokemons = [];
    let currentTab = 'prefecture';
    let currentLanguage = 'ja';

    // UI text translations
    const translations = {
      ja: {
        pageTitle: 'ğŸ—¾ ãƒã‚±ãµãŸãƒãƒƒãƒ—',
        navLink: 'ğŸ“ è¿‘ãã®ãƒãƒ³ãƒ›ãƒ¼ãƒ«',
        prefectureTab: 'ğŸ—¾ éƒ½é“åºœçœŒ',
        pokemonTab: 'ğŸ¯ ãƒã‚±ãƒ¢ãƒ³',
        prefectureFilter: 'éƒ½é“åºœçœŒã§çµã‚Šè¾¼ã¿',
        allPrefectures: 'ã™ã¹ã¦ã®éƒ½é“åºœçœŒ',
        prefectureCount: 'éƒ½é“åºœçœŒåˆ¥ãƒã‚±ãµãŸæ•°',
        searchPrefecture: 'éƒ½é“åºœçœŒã‚’æ¤œç´¢...',
        codeHeader: 'ã‚³ãƒ¼ãƒ‰',
        prefectureHeader: 'éƒ½é“åºœçœŒ',
        countHeader: 'ãƒã‚±ãµãŸæ•°',
        siteHeader: 'ã‚µã‚¤ãƒˆ',
        pokemonFilter: 'ãƒã‚±ãƒ¢ãƒ³ã§çµã‚Šè¾¼ã¿',
        searchPokemon: 'ãƒã‚±ãƒ¢ãƒ³ã‚’æ¤œç´¢...',
        showAll: 'ğŸ”„ ã™ã¹ã¦è¡¨ç¤º',
        totalCount: 'ç·æ•°:',
        visibleCount: 'è¡¨ç¤º:',
        cityCount: 'å¸‚ç”ºæ‘:',
        idLabel: 'ID:',
        titleLabel: 'ã‚¿ã‚¤ãƒˆãƒ«:',
        prefectureLabel: 'éƒ½é“åºœçœŒ:',
        pokemonLabel: 'ãƒã‚±ãƒ¢ãƒ³:',
        cityLabel: 'å¸‚ç”ºæ‘:',
        officialDetail: 'ğŸ“ å…¬å¼è©³ç´°',
        prefectureSite: 'ã‚µã‚¤ãƒˆ'
      },
      en: {
        pageTitle: 'ğŸ—¾ PokÃ©futa Map',
        navLink: 'ğŸ“ Nearby Manholes',
        prefectureTab: 'ğŸ—¾ Prefecture',
        pokemonTab: 'ğŸ¯ PokÃ©mon',
        prefectureFilter: 'Filter by Prefecture',
        allPrefectures: 'All Prefectures',
        prefectureCount: 'PokÃ©futa Count by Prefecture',
        searchPrefecture: 'Search prefecture...',
        codeHeader: 'Code',
        prefectureHeader: 'Prefecture',
        countHeader: 'Count',
        siteHeader: 'Site',
        pokemonFilter: 'Filter by PokÃ©mon',
        searchPokemon: 'Search PokÃ©mon...',
        showAll: 'ğŸ”„ Show All',
        totalCount: 'Total:',
        visibleCount: 'Visible:',
        cityCount: 'Cities:',
        idLabel: 'ID:',
        titleLabel: 'Title:',
        prefectureLabel: 'Prefecture:',
        pokemonLabel: 'PokÃ©mon:',
        cityLabel: 'City:',
        officialDetail: 'ğŸ“ Official Details',
        prefectureSite: 'Site'
      },
      zh: {
        pageTitle: 'ğŸ—¾ å®å¯ç›–åœ°å›¾',
        navLink: 'ğŸ“ é™„è¿‘çš„äº•ç›–',
        prefectureTab: 'ğŸ—¾ éƒ½é“åºœå¿',
        pokemonTab: 'ğŸ¯ å®å¯æ¢¦',
        prefectureFilter: 'æŒ‰éƒ½é“åºœå¿ç­›é€‰',
        allPrefectures: 'æ‰€æœ‰éƒ½é“åºœå¿',
        prefectureCount: 'å„éƒ½é“åºœå¿å®å¯ç›–æ•°é‡',
        searchPrefecture: 'æœç´¢éƒ½é“åºœå¿...',
        codeHeader: 'ä»£ç ',
        prefectureHeader: 'éƒ½é“åºœå¿',
        countHeader: 'æ•°é‡',
        siteHeader: 'ç½‘ç«™',
        pokemonFilter: 'æŒ‰å®å¯æ¢¦ç­›é€‰',
        searchPokemon: 'æœç´¢å®å¯æ¢¦...',
        showAll: 'ğŸ”„ æ˜¾ç¤ºå…¨éƒ¨',
        totalCount: 'æ€»æ•°:',
        visibleCount: 'æ˜¾ç¤º:',
        cityCount: 'å¸‚ç”ºæ‘:',
        idLabel: 'ID:',
        titleLabel: 'æ ‡é¢˜:',
        prefectureLabel: 'éƒ½é“åºœå¿:',
        pokemonLabel: 'å®å¯æ¢¦:',
        cityLabel: 'å¸‚ç”ºæ‘:',
        officialDetail: 'ğŸ“ å®˜æ–¹è¯¦æƒ…',
        prefectureSite: 'ç½‘ç«™'
      }
    };

    async function loadPokefutaData() {
      try {
        const response = await fetch('./pokefuta.ndjson');
        const text = await response.text();
        const lines = text.trim().split('\n');

        lines.forEach(line => {
          if (line.trim()) {
            const data = JSON.parse(line);
            allData.push(data);

            // Count by prefecture
            const prefecture = data.prefecture || 'ä¸æ˜';
            prefectureCounts[prefecture] = (prefectureCounts[prefecture] || 0) + 1;

            // Count prefecture sites
            if (data.prefecture_site_url) {
              prefectureSiteCounts[prefecture] = (prefectureSiteCounts[prefecture] || 0) + 1;
            }

            // Count cities
            if (data.city) {
              const cityKey = `${prefecture}/${data.city}`;
              cityCounts[cityKey] = (cityCounts[cityKey] || 0) + 1;
            }

            // Count Pokemon
            if (data.pokemons && Array.isArray(data.pokemons)) {
              data.pokemons.forEach(pokemon => {
                if (pokemon && pokemon.trim()) {
                  pokemonCounts[pokemon] = (pokemonCounts[pokemon] || 0) + 1;
                }
              });
            }

            const pokemons = data.pokemons && data.pokemons.length > 0
              ? data.pokemons.join(', ')
              : 'â€”';

            const prefectureCode = prefectureCodeMap[prefecture] || '--';

            const prefectureSiteLink = data.prefecture_site_url
              ? `<br/><a href='${data.prefecture_site_url}' target='_blank' class='popup-link popup-link--site'>ğŸŒ ${prefecture}ã‚µã‚¤ãƒˆ</a>`
              : '';

            const cityInfo = data.city ? `<br/><b data-i18n="cityLabel">å¸‚ç”ºæ‘:</b> ${data.city}` : '';

            const popupContent = `
              <div class='popup-box'>
                <b data-i18n="idLabel">ID:</b> ${data.id}<br/>
                <b data-i18n="titleLabel">ã‚¿ã‚¤ãƒˆãƒ«:</b> <span class="popup-title">${data.title}</span><br/>
                <b data-i18n="prefectureLabel">éƒ½é“åºœçœŒ:</b> ${prefecture} <span class="prefecture-code">${prefectureCode}</span>${cityInfo}<br/>
                <b data-i18n="pokemonLabel">ãƒã‚±ãƒ¢ãƒ³:</b> <span class="popup-pokemons">${pokemons}</span><br/>
                <a href='${data.detail_url}' target='_blank' class='popup-link' data-i18n="officialDetail">ğŸ“ å…¬å¼è©³ç´°</a>${prefectureSiteLink}
              </div>
            `;

            const marker = L.marker([data.lat, data.lng], { icon: pokefutaIcon })
              .bindPopup(popupContent);

            marker.pokefutaData = data;
            marker.pokefutaData.prefectureCode = prefectureCode;
            allMarkers.push(marker);
            marker.addTo(map);
          }
        });

        populatePrefectureFilter();
        populatePrefectureTable();
        populatePokemonGrid();
        updateStats();
      } catch (error) {
        console.error('Error loading pokefuta data:', error);
      }
    }

    function populatePrefectureFilter() {
      const select = document.getElementById('prefecture-filter');

      // Get all 47 prefectures and sort by code
      const allPrefectures = Object.keys(prefectureCodeMap)
        .sort((a, b) => {
          const codeA = prefectureCodeMap[a];
          const codeB = prefectureCodeMap[b];
          return codeA.localeCompare(codeB);
        });

      // Add ä¸æ˜ at the end if exists
      if (prefectureCounts['ä¸æ˜']) {
        allPrefectures.push('ä¸æ˜');
      }

      allPrefectures.forEach(prefecture => {
        const option = document.createElement('option');
        option.value = prefecture;
        const code = prefectureCodeMap[prefecture] || '--';
        const count = prefectureCounts[prefecture] || 0;
        option.textContent = `${code} ${prefecture} (${count})`;

        // Disable option if no pokefuta (but still show it)
        if (count === 0 && prefecture !== 'ä¸æ˜') {
          option.disabled = true;
          option.style.color = '#999';
        }

        select.appendChild(option);
      });

      select.addEventListener('change', filterByPrefecture);
    }

    function populatePrefectureTable() {
      const tbody = document.getElementById('prefecture-table-body');

      // Create array of all 47 prefectures with their counts
      const allPrefectures = Object.keys(prefectureCodeMap).map(prefecture => [
        prefecture,
        prefectureCounts[prefecture] || 0
      ]);

      // Sort by prefecture code
      allPrefectures.sort(([a], [b]) => {
        const codeA = prefectureCodeMap[a];
        const codeB = prefectureCodeMap[b];
        return codeA.localeCompare(codeB);
      });

      // Add ä¸æ˜ at the end if exists
      if (prefectureCounts['ä¸æ˜']) {
        allPrefectures.push(['ä¸æ˜', prefectureCounts['ä¸æ˜']]);
      }

      allPrefectures.forEach(([prefecture, count]) => {
        const row = document.createElement('tr');
        const code = prefectureCodeMap[prefecture] || '--';
        const siteCount = prefectureSiteCounts[prefecture] || 0;
        const siteIcon = siteCount > 0 ? 'ğŸŒ' : 'â€”';

        // Style row differently if no pokefuta
        const countBadgeClass = count > 0 ? 'count-badge' : 'count-badge-zero';
        const rowClass = count === 0 ? 'no-pokefuta' : '';

        row.className = rowClass;
        row.innerHTML = `
          <td><span class="prefecture-code">${code}</span></td>
          <td>${prefecture}</td>
          <td><span class="${countBadgeClass}">${count}</span></td>
          <td style="text-align: center;">${siteIcon}</td>
        `;

        // Only add click handler if there are pokefuta
        if (count > 0) {
          row.addEventListener('click', () => {
            selectPrefectureFromTable(prefecture, row);
          });
          row.style.cursor = 'pointer';
        }

        tbody.appendChild(row);
      });

      // Add search functionality
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', searchPrefectures);
    }

    function selectPrefectureFromTable(prefecture, row) {
      // Update dropdown
      document.getElementById('prefecture-filter').value = prefecture;

      // Update table selection
      document.querySelectorAll('.prefecture-table tr').forEach(r => r.classList.remove('selected'));
      row.classList.add('selected');

      // Filter map
      selectedPrefecture = prefecture;
      filterByPrefecture();
    }

    function filterByPrefecture() {
      const selectedPref = document.getElementById('prefecture-filter').value || selectedPrefecture;
      let visibleCount = 0;

      allMarkers.forEach(marker => {
        const shouldShow = !selectedPref || marker.pokefutaData.prefecture === selectedPref;

        if (shouldShow) {
          if (!map.hasLayer(marker)) {
            marker.addTo(map);
          }
          visibleCount++;
        } else {
          if (map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
        }
      });

      updateStats(visibleCount);

      // Highlight table row
      updateTableSelection(selectedPref);

      // Adjust map view
      if (selectedPref) {
        fitMapToPrefecture(selectedPref);
      }
    }

    function updateTableSelection(prefecture) {
      document.querySelectorAll('.prefecture-table tr').forEach(row => {
        row.classList.remove('selected');
        const prefCell = row.cells[1];
        if (prefCell && prefCell.textContent === prefecture) {
          row.classList.add('selected');
        }
      });
    }

    function searchPrefectures() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const rows = document.querySelectorAll('#prefecture-table-body tr');

      rows.forEach(row => {
        const prefecture = row.cells[1].textContent.toLowerCase();
        const code = row.cells[0].textContent.toLowerCase();
        const shouldShow = prefecture.includes(query) || code.includes(query);
        row.style.display = shouldShow ? '' : 'none';
      });
    }

    function fitMapToPrefecture(prefecture) {
      const prefectureMarkers = allMarkers.filter(marker =>
        marker.pokefutaData.prefecture === prefecture
      );

      if (prefectureMarkers.length > 0) {
        const group = new L.featureGroup(prefectureMarkers);
        map.fitBounds(group.getBounds(), { padding: [20, 20] });
      }
    }

    function updateStats(visibleCount = null) {
      const totalElement = document.querySelector('#total-count span');
      const visibleElement = document.querySelector('#visible-count span');
      const cityElement = document.querySelector('#city-count span');

      totalElement.textContent = allMarkers.length;
      visibleElement.textContent = visibleCount !== null ? visibleCount : allMarkers.length;
      cityElement.textContent = Object.keys(cityCounts).length;
    }

    function populatePokemonGrid() {
      const grid = document.getElementById('pokemon-grid');

      // Collect all Pokemon data including multilingual versions
      const allPokemonData = {};

      allData.forEach(data => {
        // Japanese Pokemon
        if (data.pokemons && Array.isArray(data.pokemons)) {
          data.pokemons.forEach(pokemon => {
            if (pokemon && pokemon.trim()) {
              if (!allPokemonData[pokemon]) {
                allPokemonData[pokemon] = { ja: pokemon, en: '', zh: '', count: 0 };
              }
              allPokemonData[pokemon].count++;
            }
          });
        }

        // English Pokemon
        if (data.pokemons_en && Array.isArray(data.pokemons_en)) {
          data.pokemons_en.forEach((pokemon, index) => {
            if (pokemon && pokemon.trim()) {
              const jaPokemon = data.pokemons[index] || pokemon;
              if (!allPokemonData[jaPokemon]) {
                allPokemonData[jaPokemon] = { ja: jaPokemon, en: pokemon, zh: '', count: 0 };
              } else {
                allPokemonData[jaPokemon].en = pokemon;
              }
            }
          });
        }

        // Chinese Pokemon
        if (data.pokemons_zh && Array.isArray(data.pokemons_zh)) {
          data.pokemons_zh.forEach((pokemon, index) => {
            if (pokemon && pokemon.trim()) {
              const jaPokemon = data.pokemons[index] || pokemon;
              if (!allPokemonData[jaPokemon]) {
                allPokemonData[jaPokemon] = { ja: jaPokemon, en: '', zh: pokemon, count: 0 };
              } else {
                allPokemonData[jaPokemon].zh = pokemon;
              }
            }
          });
        }
      });

      const sortedPokemons = Object.entries(allPokemonData)
        .sort(([a], [b]) => a.localeCompare(b, 'ja'))
        .sort(([, dataA], [, dataB]) => dataB.count - dataA.count);

      grid.innerHTML = '';

      sortedPokemons.forEach(([pokemon, pokemonData]) => {
        const item = document.createElement('div');
        item.className = 'pokemon-item';

        // Get current language display name
        let displayName = pokemonData.ja;
        if (currentLanguage === 'en' && pokemonData.en) {
          displayName = pokemonData.en;
        } else if (currentLanguage === 'zh' && pokemonData.zh) {
          displayName = pokemonData.zh;
        }

        item.innerHTML = `
          <div class="pokemon-name">${displayName}</div>
          <div class="pokemon-count">${pokemonData.count}</div>
        `;

        item.addEventListener('click', () => {
          togglePokemonSelection(pokemon, item);
        });

        grid.appendChild(item);
      });

      // Add search functionality for Pokemon
      const searchInput = document.getElementById('pokemon-search');
      searchInput.removeEventListener('input', searchPokemons); // Remove existing listener
      searchInput.addEventListener('input', searchPokemons);
    }

    function togglePokemonSelection(pokemon, item) {
      const index = selectedPokemons.indexOf(pokemon);

      if (index > -1) {
        selectedPokemons.splice(index, 1);
        item.classList.remove('selected');
      } else {
        selectedPokemons.push(pokemon);
        item.classList.add('selected');
      }

      filterByPokemon();
    }

    function searchPokemons() {
      const query = document.getElementById('pokemon-search').value.toLowerCase();
      const items = document.querySelectorAll('#pokemon-grid .pokemon-item');

      items.forEach(item => {
        const pokemonName = item.querySelector('.pokemon-name').textContent.toLowerCase();
        const shouldShow = pokemonName.includes(query);
        item.style.display = shouldShow ? 'block' : 'none';
      });
    }

    function filterByPokemon() {
      if (selectedPokemons.length === 0) {
        // Show all markers if no Pokemon selected
        allMarkers.forEach(marker => {
          if (!map.hasLayer(marker)) {
            marker.addTo(map);
          }
        });
        updateStats();
        return;
      }

      let visibleCount = 0;

      allMarkers.forEach(marker => {
        const markerPokemons = marker.pokefutaData.pokemons || [];
        const shouldShow = selectedPokemons.some(selectedPokemon =>
          markerPokemons.includes(selectedPokemon)
        );

        if (shouldShow) {
          if (!map.hasLayer(marker)) {
            marker.addTo(map);
          }
          visibleCount++;
        } else {
          if (map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
        }
      });

      updateStats(visibleCount);
    }

    function switchTab(tabName) {
      currentTab = tabName;
      const tabs = ['prefecture','pokemon'];
      tabs.forEach(name => {
        const btn = document.getElementById(`tab-${name}`);
        const panel = document.getElementById(`${name}-tab`);
        const active = name === tabName;
        if (btn) {
          btn.classList.toggle('active', active);
          btn.setAttribute('aria-selected', active ? 'true':'false');
          btn.tabIndex = active ? 0 : -1;
        }
        if (panel) {
          panel.classList.toggle('active', active);
          if (active) {
            panel.removeAttribute('hidden');
            panel.setAttribute('aria-hidden','false');
          } else {
            panel.setAttribute('hidden','true');
            panel.setAttribute('aria-hidden','true');
          }
        }
      });
      if (tabName === 'prefecture') {
        selectedPokemons = [];
        document.querySelectorAll('#pokemon-grid .pokemon-item').forEach(item => item.classList.remove('selected'));
        const ps = document.getElementById('pokemon-search'); if (ps) ps.value='';
        filterByPrefecture();
      } else if (tabName === 'pokemon') {
        selectedPrefecture = '';
        const pf = document.getElementById('prefecture-filter'); if (pf) pf.value='';
        const si = document.getElementById('search-input'); if (si) si.value='';
        document.querySelectorAll('.prefecture-table tr').forEach(row => { row.classList.remove('selected'); row.style.display=''; });
        filterByPokemon();
      }
    }

    function resetMap() {
      // Reset filters for both tabs
      document.getElementById('prefecture-filter').value = '';
      document.getElementById('search-input').value = '';
      document.getElementById('pokemon-search').value = '';
      selectedPrefecture = '';
      selectedPokemons = [];

      // Show all markers
      allMarkers.forEach(marker => {
        if (!map.hasLayer(marker)) {
          marker.addTo(map);
        }
      });

      // Show all table rows
      document.querySelectorAll('#prefecture-table-body tr').forEach(row => {
        row.style.display = '';
        row.classList.remove('selected');
      });

      // Reset Pokemon selections
      document.querySelectorAll('#pokemon-grid .pokemon-item').forEach(item => {
        item.classList.remove('selected');
        item.style.display = 'block';
      });

      // Reset map view
      map.setView([36.0, 138.0], 6);
      updateStats();
    }

    function switchLanguage(lang) {
      currentLanguage = lang;
      document.querySelectorAll('.lang-btn').forEach(btn => {
        const active = btn.getAttribute('data-lang') === lang;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true':'false');
      });
      updateUIText();
      refreshMarkersContent();
    }

    function updateUIText() {
      const t = translations[currentLanguage];

      // Update header
      document.getElementById('page-title').textContent = t.pageTitle;
      document.getElementById('nav-link').textContent = t.navLink;

      // Update tab buttons
      document.querySelector('.tab-button[onclick="switchTab(\'prefecture\')"]').innerHTML = t.prefectureTab;
      document.querySelector('.tab-button[onclick="switchTab(\'pokemon\')"]').innerHTML = t.pokemonTab;

      // Update prefecture section
      document.querySelector('#prefecture-tab h4').textContent = t.prefectureFilter;
      document.querySelector('#prefecture-filter option[value=""]').textContent = t.allPrefectures;
      document.querySelectorAll('#prefecture-tab h4')[1].textContent = t.prefectureCount;
      document.getElementById('search-input').placeholder = t.searchPrefecture;

      // Update table headers
      const headers = document.querySelectorAll('.prefecture-table th');
      if (headers.length >= 4) {
        headers[0].textContent = t.codeHeader;
        headers[1].textContent = t.prefectureHeader;
        headers[2].textContent = t.countHeader;
        headers[3].textContent = t.siteHeader;
      }

      // Update pokemon section
      document.querySelector('#pokemon-tab h4').textContent = t.pokemonFilter;
      document.getElementById('pokemon-search').placeholder = t.searchPokemon;

      // Update reset button
      document.querySelector('.reset-btn').textContent = t.showAll;

      // Update stats
      document.querySelector('#total-count').innerHTML = `${t.totalCount} <span>${allMarkers.length}</span>`;
      document.querySelector('#visible-count').innerHTML = `${t.visibleCount} <span>${document.querySelectorAll('#map .leaflet-marker-pane img').length}</span>`;
      document.querySelector('#city-count').innerHTML = `${t.cityCount} <span>${Object.keys(cityCounts).length}</span>`;

      // Refresh Pokemon grid to show names in current language
      populatePokemonGrid();
    }

    function refreshMarkersContent() {
      allMarkers.forEach(marker => {
        const data = marker.pokefutaData;
        const t = translations[currentLanguage];

        // Get multilingual content
        let title = data.title;
        let pokemons = data.pokemons && data.pokemons.length > 0 ? data.pokemons.join(', ') : 'â€”';

        if (currentLanguage === 'en') {
          title = data.title_en || data.title;
          if (data.pokemons_en && data.pokemons_en.length > 0) {
            pokemons = data.pokemons_en.join(', ');
          }
        } else if (currentLanguage === 'zh') {
          title = data.title_zh || data.title;
          if (data.pokemons_zh && data.pokemons_zh.length > 0) {
            pokemons = data.pokemons_zh.join(', ');
          }
        }

        const prefecture = data.prefecture || 'ä¸æ˜';
        const prefectureCode = data.prefectureCode || '--';
        const cityInfo = data.city ? `<br/><b>${t.cityLabel}</b> ${data.city}` : '';

        const prefectureSiteLink = data.prefecture_site_url
          ? `<br/><a href='${data.prefecture_site_url}' target='_blank' class='popup-link popup-link--site'>ğŸŒ ${prefecture}${t.prefectureSite}</a>`
          : '';

        const popupContent = `
          <div class='popup-box'>
            <b>${t.idLabel}</b> ${data.id}<br/>
            <b>${t.titleLabel}</b> ${title}<br/>
            <b>${t.prefectureLabel}</b> ${prefecture} <span class="prefecture-code">${prefectureCode}</span>${cityInfo}<br/>
            <b>${t.pokemonLabel}</b> ${pokemons}<br/>
            <a href='${data.detail_url}' target='_blank' class='popup-link'>${t.officialDetail}</a>${prefectureSiteLink}
          </div>
        `;

        marker.setPopupContent(popupContent);
      });
    }

    // Keyboard navigation for tabs (Left/Right/Home/End)
    document.addEventListener('keydown', (e) => {
      const activeEl = document.activeElement;
      if (activeEl && activeEl.getAttribute('role') === 'tab') {
        const order = ['prefecture','pokemon'];
        let idx = order.findIndex(t => `tab-${t}` === activeEl.id);
        if (e.key === 'ArrowRight') { e.preventDefault(); idx = (idx + 1) % order.length; document.getElementById(`tab-${order[idx]}`).focus(); switchTab(order[idx]); }
        else if (e.key === 'ArrowLeft') { e.preventDefault(); idx = (idx - 1 + order.length) % order.length; document.getElementById(`tab-${order[idx]}`).focus(); switchTab(order[idx]); }
        else if (e.key === 'Home') { e.preventDefault(); document.getElementById('tab-prefecture').focus(); switchTab('prefecture'); }
        else if (e.key === 'End') { e.preventDefault(); document.getElementById('tab-pokemon').focus(); switchTab('pokemon'); }
      }
    });

    // Initialize
    loadPokefutaData();
  </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LX58JGRPNV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LX58JGRPNV');
</script>