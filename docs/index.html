<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pokéfuta Mini Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="./assets/theme.css" />
  <link rel="stylesheet" href="./assets/map.css" />
</head>
<body>
  <div id="controls" role="complementary" aria-labelledby="page-title">
    <div class="controls-header">
      <h3 id="page-title"><img src=../dataset/manhole_icon.png width="30">ポケふたマップ</h3>
      <!-- 言語切替ボタンは廃止（多言語 UI 非表示）。必要になれば復活可能。 -->
      <a href="/pokefuta-tracker/nearby.html" class="nav-link" id="nav-link">📍 近くのマンホール</a>
    </div>
    <div class="controls-content" role="region" aria-label="Filters and statistics">
      <div class="tab-buttons" role="tablist" aria-label="Filter type">
        <button class="tab-button active" role="tab" aria-selected="true" aria-controls="prefecture-tab" id="tab-prefecture" onclick="switchTab('prefecture')">🗾 都道府県</button>
        <button class="tab-button" role="tab" aria-selected="false" aria-controls="pokemon-tab" id="tab-pokemon" onclick="switchTab('pokemon')">🎯 ポケモン</button>
      </div>
      <!-- Added recent 1 month filter -->
      <div class="filter-section filter-panel" id="recent-filter-wrapper">
        <label style="cursor:pointer;">
          <input type="checkbox" id="recent-toggle" /> <span data-i18n="recentLabel">🆕 直近1ヶ月</span>
        </label>
      </div>
      <div id="prefecture-tab" class="tab-content active" role="tabpanel" tabindex="0" aria-labelledby="tab-prefecture">
        <div class="filter-section filter-panel">
          <h4 id="heading-pref-filter">都道府県で絞り込み</h4>
          <label class="sr-only" for="prefecture-filter">都道府県セレクト</label>
          <select id="prefecture-filter" aria-labelledby="heading-pref-filter">
            <option value="">すべての都道府県</option>
          </select>
        </div>
        <div class="filter-section filter-panel" aria-labelledby="heading-pref-count">
          <h4 id="heading-pref-count">都道府県別ポケふた数</h4>
          <label class="sr-only" for="search-input">都道府県検索</label>
          <input type="text" class="search-input" id="search-input" placeholder="都道府県を検索..." aria-describedby="pref-table-desc">
          <table class="prefecture-table" id="prefecture-table" aria-describedby="pref-table-desc">
            <caption id="pref-table-desc" class="sr-only">都道府県ごとのポケふた数とサイト有無</caption>
            <thead>
              <tr>
                <th scope="col">コード</th>
                <th scope="col">都道府県</th>
                <th scope="col">ポケふた数</th>
                <th scope="col">サイト</th>
              </tr>
            </thead>
            <tbody id="prefecture-table-body"></tbody>
          </table>
        </div>
      </div>
      <div id="pokemon-tab" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-pokemon" hidden>
        <div class="filter-section filter-panel">
          <h4 id="heading-pokemon-filter">ポケモンで絞り込み</h4>
          <label class="sr-only" for="pokemon-search">ポケモン検索</label>
          <input type="text" class="search-input" id="pokemon-search" placeholder="ポケモンを検索...">
          <div id="pokemon-grid" class="pokemon-grid" role="list" aria-label="ポケモン一覧"></div>
        </div>
      </div>
      <button class="reset-btn" onclick="resetMap()" aria-live="polite">🔄 すべて表示</button>
      <div class="stats" role="status" aria-live="polite">
        <div id="total-count">総数: <span>0</span></div>
        <div id="visible-count">表示: <span>0</span></div>
        <div id="city-count">市町村: <span>0</span></div>
      </div>
    </div>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const pokefutaIcon = L.icon({
  iconUrl: './pokefuta_icon_32.png',  // 32px版を使う場合
  iconSize: [32, 32],                 // アイコンのサイズ
  iconAnchor: [16, 16],               // 中心に合わせる（[横/2, 縦/2]）
  popupAnchor: [0, -16]               // ポップアップの位置補正
});
    const map = L.map('map').setView([36.0, 138.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 都道府県コードマッピング
    const prefectureCodeMap = {
      '北海道': '01', '青森県': '02', '岩手県': '03', '宮城県': '04', '秋田県': '05',
      '山形県': '06', '福島県': '07', '茨城県': '08', '栃木県': '09', '群馬県': '10',
      '埼玉県': '11', '千葉県': '12', '東京都': '13', '神奈川県': '14', '新潟県': '15',
      '富山県': '16', '石川県': '17', '福井県': '18', '山梨県': '19', '長野県': '20',
      '岐阜県': '21', '静岡県': '22', '愛知県': '23', '三重県': '24', '滋賀県': '25',
      '京都府': '26', '大阪府': '27', '兵庫県': '28', '奈良県': '29', '和歌山県': '30',
      '鳥取県': '31', '島根県': '32', '岡山県': '33', '広島県': '34', '山口県': '35',
      '徳島県': '36', '香川県': '37', '愛媛県': '38', '高知県': '39', '福岡県': '40',
      '佐賀県': '41', '長崎県': '42', '熊本県': '43', '大分県': '44', '宮崎県': '45',
      '鹿児島県': '46', '沖縄県': '47'
    };

    let allMarkers = [];
    let allData = [];
    let prefectureCounts = {};
    let prefectureSiteCounts = {};
    let cityCounts = {};
    let selectedPrefecture = '';
    let pokemonCounts = {};
    let selectedPokemons = [];
    let currentTab = 'prefecture';
    let filterRecent = false; // recent 30 days filter
    let hasAddedAtField = false; // whether dataset has any date field

    // ==== 単一言語 (日本語) 用 UI ラベル定数 ==== 
    const UI_TEXT = {
      recentLabel: '🆕 直近1ヶ月',
      prefectureFilter: '都道府県で絞り込み',
      allPrefectures: 'すべての都道府県',
      prefectureCount: '都道府県別ポケふた数',
      searchPrefecture: '都道府県を検索...',
      codeHeader: 'コード',
      prefectureHeader: '都道府県',
      countHeader: 'ポケふた数',
      siteHeader: 'サイト',
      pokemonFilter: 'ポケモンで絞り込み',
      searchPokemon: 'ポケモンを検索...',
      showAll: '🔄 すべて表示',
      totalCount: '総数:',
      visibleCount: '表示:',
      cityCount: '市町村:',
      idLabel: 'ID:',
      titleLabel: 'タイトル:',
      prefectureLabel: '都道府県:',
      pokemonLabel: 'ポケモン:',
      cityLabel: '市町村:',
      officialDetail: '📝 公式詳細',
      prefectureSite: 'サイト'
    };

    // 初期テキストは既に HTML に記述しているため updateUIText は不要
    function updateUIText() { /* no-op (多言語削除) */ }

    async function loadPokefutaData() {
      try {
        const res = await fetch('./pokefuta.ndjson');
        const text = await res.text();
        const lines = text.trim().split('\n');
        allData = [];
        const latestById = new Map();
        for (const line of lines) {
          if (!line.trim()) continue;
          const obj = JSON.parse(line);
          if (!latestById.has(obj.id) || new Date(obj.source_last_checked) > new Date(latestById.get(obj.id).source_last_checked)) {
            latestById.set(obj.id, obj);
          }
        }
        allData = [...latestById.values()];
        // Detect presence of date field for recent filter
        hasAddedAtField = allData.some(d => d.added_at || d.first_seen || d.date);
        // Pre-compute added date object
        allData.forEach(d => {
          const ds = d.added_at || d.first_seen || d.date;
          d._addedDate = ds ? new Date(ds) : null;
        });
        // Build markers
        allMarkers = [];
        prefectureCounts = {}; prefectureSiteCounts = {}; cityCounts = {}; pokemonCounts = {};
        allData.forEach(d => {
          const prefecture = d.prefecture || '不明';
          const prefectureCode = prefectureCodeMap[prefecture] || '--';
          prefectureCounts[prefecture] = (prefectureCounts[prefecture] || 0) + 1;
          if (d.prefecture_site_url) {
            prefectureSiteCounts[prefecture] = (prefectureSiteCounts[prefecture] || 0) + 1;
          }
          if (d.city) cityCounts[d.city] = (cityCounts[d.city] || 0) + 1;
          if (Array.isArray(d.pokemons)) {
            d.pokemons.forEach(p => { if (p) pokemonCounts[p] = (pokemonCounts[p] || 0) + 1; });
          }
          const pokemonsStr = Array.isArray(d.pokemons) && d.pokemons.length ? d.pokemons.join(', ') : '—';
          const cityInfo = d.city ? `<br/><b>${UI_TEXT.cityLabel}</b> ${d.city}` : '';
          const prefectureSiteLink = d.prefecture_site_url ? `<br/><a href='${d.prefecture_site_url}' target='_blank' class='popup-link popup-link--site'>🌐 ${prefecture}${UI_TEXT.prefectureSite}</a>` : '';
          const popupContent = `
            <div class='popup-box'>
              <b>${UI_TEXT.idLabel}</b> ${d.id}<br/>
              <b>${UI_TEXT.titleLabel}</b> <span class="popup-title">${d.title}</span><br/>
              <b>${UI_TEXT.prefectureLabel}</b> ${prefecture} <span class="prefecture-code">${prefectureCode}</span>${cityInfo}<br/>
              <b>${UI_TEXT.pokemonLabel}</b> <span class="popup-pokemons">${pokemonsStr}</span><br/>
              <a href='${d.detail_url}' target='_blank' class='popup-link'>${UI_TEXT.officialDetail}</a>${prefectureSiteLink}
            </div>
          `;
          const marker = L.marker([d.lat, d.lng], { icon: pokefutaIcon }).bindPopup(popupContent);
          marker.pokefutaData = d; marker.pokefutaData.prefectureCode = prefectureCode;
          allMarkers.push(marker); marker.addTo(map);
        });
        populatePrefectureFilter();
        populatePrefectureTable();
        populatePokemonGrid();
        updateStats();
        initRecentFilter();
      } catch (e) {
        console.error('ポケふたデータ読み込み失敗', e);
      }
    }

    function initRecentFilter() {
      const toggle = document.getElementById('recent-toggle');
      if (!toggle) return;
      if (!hasAddedAtField) {
        toggle.disabled = true;
        toggle.title = 'データに日付フィールド (added_at / first_seen / date) が無いため利用できません';
      }
      toggle.addEventListener('change', e => {
        filterRecent = e.target.checked;
        recomputeVisibility();
      });
    }

    function isWithinLastDays(dateObj, days) {
      if (!dateObj) return false;
      const now = new Date();
      return (now - dateObj) <= days * 86400000 && (now - dateObj) >= 0;
    }

    function recomputeVisibility() {
      let visibleCount = 0;
      allMarkers.forEach(marker => {
        const d = marker.pokefutaData;
        let show = true;
        if (selectedPrefecture) show = show && d.prefecture === selectedPrefecture;
        if (selectedPokemons.length > 0) {
          const mp = d.pokefutaData ? d.pokefutaData.pokemons : (d.pokemons || []);
          const pList = d.pokemons || [];
          show = show && selectedPokemons.some(p => pList.includes(p));
        }
        if (filterRecent) show = show && isWithinLastDays(d._addedDate, 30);
        if (show) {
          if (!map.hasLayer(marker)) marker.addTo(map);
          visibleCount++;
        } else {
          if (map.hasLayer(marker)) map.removeLayer(marker);
        }
      });
      updateStats(visibleCount);
    }

    function populatePrefectureFilter() {
      const select = document.getElementById('prefecture-filter');

      // Get all 47 prefectures and sort by code
      const allPrefectures = Object.keys(prefectureCodeMap)
        .sort((a, b) => {
          const codeA = prefectureCodeMap[a];
          const codeB = prefectureCodeMap[b];
          return codeA.localeCompare(codeB);
        });

      // Add 不明 at the end if exists
      if (prefectureCounts['不明']) {
        allPrefectures.push('不明');
      }

      allPrefectures.forEach(prefecture => {
        const option = document.createElement('option');
        option.value = prefecture;
        const code = prefectureCodeMap[prefecture] || '--';
        const count = prefectureCounts[prefecture] || 0;
        option.textContent = `${code} ${prefecture} (${count})`;

        // Disable option if no pokefuta (but still show it)
        if (count === 0 && prefecture !== '不明') {
          option.disabled = true;
          option.style.color = '#999';
        }

        select.appendChild(option);
      });

      select.addEventListener('change', filterByPrefecture);
    }

    function populatePrefectureTable() {
      const tbody = document.getElementById('prefecture-table-body');

      // Create array of all 47 prefectures with their counts
      const allPrefectures = Object.keys(prefectureCodeMap).map(prefecture => [
        prefecture,
        prefectureCounts[prefecture] || 0
      ]);

      // Sort by prefecture code
      allPrefectures.sort(([a], [b]) => {
        const codeA = prefectureCodeMap[a];
        const codeB = prefectureCodeMap[b];
        return codeA.localeCompare(codeB);
      });

      // Add 不明 at the end if exists
      if (prefectureCounts['不明']) {
        allPrefectures.push(['不明', prefectureCounts['不明']]);
      }

      allPrefectures.forEach(([prefecture, count]) => {
        const row = document.createElement('tr');
        const code = prefectureCodeMap[prefecture] || '--';
        const siteCount = prefectureSiteCounts[prefecture] || 0;
        const siteIcon = siteCount > 0 ? '🌐' : '—';

        // Style row differently if no pokefuta
        const countBadgeClass = count > 0 ? 'count-badge' : 'count-badge-zero';
        const rowClass = count === 0 ? 'no-pokefuta' : '';

        row.className = rowClass;
        row.innerHTML = `
          <td><span class="prefecture-code">${code}</span></td>
          <td>${prefecture}</td>
          <td><span class="${countBadgeClass}">${count}</span></td>
          <td style="text-align: center;">${siteIcon}</td>
        `;

        // Only add click handler if there are pokefuta
        if (count > 0) {
          row.addEventListener('click', () => {
            selectPrefectureFromTable(prefecture, row);
          });
          row.style.cursor = 'pointer';
        }

        tbody.appendChild(row);
      });

      // Add search functionality
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', searchPrefectures);
    }

    function selectPrefectureFromTable(prefecture, row) {
      // Update dropdown
      document.getElementById('prefecture-filter').value = prefecture;

      // Update table selection
      document.querySelectorAll('.prefecture-table tr').forEach(r => r.classList.remove('selected'));
      row.classList.add('selected');

      // Filter map
      selectedPrefecture = prefecture;
      filterByPrefecture();
    }

    // ポケモングリッド生成 (日本語のみ)
    function populatePokemonGrid() {
      const grid = document.getElementById('pokemon-grid');
      if (!grid) return;
      const counts = {};
      allData.forEach(d => {
        if (Array.isArray(d.pokemons)) {
          d.pokemons.forEach(p => { if (p) counts[p] = (counts[p] || 0) + 1; });
        }
      });
      const sorted = Object.entries(counts)
        .sort(([a],[b]) => a.localeCompare(b,'ja'))
        .sort(([,ca],[,cb]) => cb - ca);
      grid.innerHTML = '';
      sorted.forEach(([name,count]) => {
        const item = document.createElement('div');
        item.className = 'pokemon-item';
        item.innerHTML = `<div class="pokemon-name">${name}</div><div class="pokemon-count">${count}</div>`;
        item.addEventListener('click', () => togglePokemonSelection(name, item));
        grid.appendChild(item);
      });
      const searchInput = document.getElementById('pokemon-search');
      if (searchInput) {
        searchInput.removeEventListener('input', searchPokemons);
        searchInput.addEventListener('input', searchPokemons);
      }
    }

    function togglePokemonSelection(pokemon, item) {
      const index = selectedPokemons.indexOf(pokemon);

      if (index > -1) {
        selectedPokemons.splice(index, 1);
        item.classList.remove('selected');
      } else {
        selectedPokemons.push(pokemon);
        item.classList.add('selected');
      }

      filterByPokemon();
    }

    function searchPokemons() {
      const query = document.getElementById('pokemon-search').value.toLowerCase();
      const items = document.querySelectorAll('#pokemon-grid .pokemon-item');

      items.forEach(item => {
        const pokemonName = item.querySelector('.pokemon-name').textContent.toLowerCase();
        const shouldShow = pokemonName.includes(query);
        item.style.display = shouldShow ? 'block' : 'none';
      });
    }

    function filterByPokemon() { recomputeVisibility(); }

    function resetMap() {
      // Reset filters for both tabs
      document.getElementById('prefecture-filter').value = '';
      document.getElementById('search-input').value = '';
      document.getElementById('pokemon-search').value = '';
      selectedPrefecture = '';
      selectedPokemons = [];
      filterRecent = false; const rt = document.getElementById('recent-toggle'); if (rt) rt.checked = false;

      // Show all markers
      allMarkers.forEach(marker => {
        if (!map.hasLayer(marker)) {
          marker.addTo(map);
        }
      });

      // Show all table rows
      document.querySelectorAll('#prefecture-table-body tr').forEach(row => {
        row.style.display = '';
        row.classList.remove('selected');
      });

      // Reset Pokemon selections
      document.querySelectorAll('#pokemon-grid .pokemon-item').forEach(item => {
        item.classList.remove('selected');
        item.style.display = 'block';
      });

      // Reset map view
      map.setView([36.0, 138.0], 6);
      updateStats();
      recomputeVisibility();
    }

    function switchTab(tabName) {
      currentTab = tabName;
      const tabs = ['prefecture','pokemon'];
      tabs.forEach(name => {
        const btn = document.getElementById(`tab-${name}`);
        const panel = document.getElementById(`${name}-tab`);
        const active = name === tabName;
        if (btn) {
          btn.classList.toggle('active', active);
          btn.setAttribute('aria-selected', active ? 'true':'false');
          btn.tabIndex = active ? 0 : -1;
        }
        if (panel) {
          panel.classList.toggle('active', active);
          if (active) {
            panel.removeAttribute('hidden');
            panel.setAttribute('aria-hidden','false');
          } else {
            panel.setAttribute('hidden','true');
            panel.setAttribute('aria-hidden','true');
          }
        }
      });
      if (tabName === 'prefecture') {
        selectedPokemons = [];
        document.querySelectorAll('#pokemon-grid .pokemon-item').forEach(item => item.classList.remove('selected'));
        const ps = document.getElementById('pokemon-search'); if (ps) ps.value='';
        filterByPrefecture();
      } else if (tabName === 'pokemon') {
        selectedPrefecture = '';
        const pf = document.getElementById('prefecture-filter'); if (pf) pf.value='';
        const si = document.getElementById('search-input'); if (si) si.value='';
        document.querySelectorAll('.prefecture-table tr').forEach(row => { row.classList.remove('selected'); row.style.display=''; });
        filterByPokemon();
      }
    }

    // 多言語機能削除のため switchLanguage / refreshMarkersContent は不要

    // Keyboard navigation for tabs (Left/Right/Home/End)
    document.addEventListener('keydown', (e) => {
      const activeEl = document.activeElement;
      if (activeEl && activeEl.getAttribute('role') === 'tab') {
        const order = ['prefecture','pokemon'];
        let idx = order.findIndex(t => `tab-${t}` === activeEl.id);
        if (e.key === 'ArrowRight') { e.preventDefault(); idx = (idx + 1) % order.length; document.getElementById(`tab-${order[idx]}`).focus(); switchTab(order[idx]); }
        else if (e.key === 'ArrowLeft') { e.preventDefault(); idx = (idx - 1 + order.length) % order.length; document.getElementById(`tab-${order[idx]}`).focus(); switchTab(order[idx]); }
        else if (e.key === 'Home') { e.preventDefault(); document.getElementById('tab-prefecture').focus(); switchTab('prefecture'); }
        else if (e.key === 'End') { e.preventDefault(); document.getElementById('tab-pokemon').focus(); switchTab('pokemon'); }
      }
    });

    // Initialize
    loadPokefutaData();
  </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LX58JGRPNV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LX58JGRPNV');
</script>